import React, { useEffect, useMemo, useRef, useState } from "react";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend,
  BarChart,
  Bar,
} from "recharts";
import {
  Plus,
  Trash2,
  Settings as SettingsIcon,
  BarChart3,
  FolderGit2,
  Camera,
  ScanLine,
  Edit3,
  GripVertical,
  ShoppingCart,
  CheckCircle2,
  Circle,
  Search,
  Upload,
  Download,
  Package,
  DollarSign,
} from "lucide-react";
import Sortable from "sortablejs";
import { Html5Qrcode } from "html5-qrcode";

// ------------------------------------------------------------
// ShopTally Pro — A better shopping trip spending tracker
// ------------------------------------------------------------
// Key upgrades vs your V3:
// • Per-list budgets with live progress + over/under alerts
// • Toggle tax (e.g., Ontario HST 13%) and price-includes-tax option
// • Categories + stores + per-unit math (e.g., $/kg, $/L)
// • Planned vs Purchased flow with fast “checkout” mode
// • Quick-add: frequent items suggestions
// • Search + filters + sort + keyboard shortcuts
// • Enhanced analytics: by list, category, store + CSV/JSON export
// • Backup/restore with versioning + image compression for receipts/tags
// • Dark mode + compact mobile-first UI
// ------------------------------------------------------------

// ---------- Utilities ----------
const VERSION = "stp_v1";
const COLORS = [
  "#8e44ad",
  "#3498db",
  "#27ae60",
  "#f39c12",
  "#c0392b",
  "#16a085",
  "#2c3e50",
  "#e67e22",
  "#7f8c8d",
];

const genId = () => `${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 9)}`;

function useLocalStorage(key, initial) {
  const [state, setState] = useState(() => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    } catch {
      return initial;
    }
  });
  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(state));
    } catch {}
  }, [key, state]);
  return [state, setState];
}

function currencyFmt(value, currency) {
  return new Intl.NumberFormat(undefined, { style: "currency", currency: currency || "USD" }).format(Number(value) || 0);
}

async function fileToDataUrl(file, maxW = 640, quality = 0.7) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const scale = Math.min(maxW / img.width, 1);
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL("image/jpeg", quality);
        resolve(dataUrl);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

// ---------- Types (for clarity) ----------
// List: { id, name, createdAt, groupId, budget, store, items: Item[] }
// Item: { id, name, price, quantity, unitName, unitSize, category, store, purchased, photo, barcode, createdAt }
// Group: { id, name }

// ---------- Default Data ----------
const DEFAULT_SETTINGS = {
  currency: "CAD",
  taxRate: 0.13, // Ontario HST as sensible default for you
  pricesIncludeTax: false,
  theme: "auto", // auto | light | dark
};

const DEFAULT_STATE = {
  version: VERSION,
  lists: {},
  groups: {},
  currentListId: null,
  settings: DEFAULT_SETTINGS,
};

// ---------- Root Component ----------
export default function ShopTallyPro() {
  const [data, setData] = useLocalStorage("ShopTallyPro", DEFAULT_STATE);
  const [scannerOpen, setScannerOpen] = useState(false);
  const [scannerLoading, setScannerLoading] = useState(false);
  const [html5Qr, setHtml5Qr] = useState(null);
  const qrRef = useRef(null);
  const listRef = useRef(null);

  // Form state
  const [newItem, setNewItem] = useState({
    name: "",
    price: "",
    quantity: 1,
    unitName: "",
    unitSize: "",
    category: "",
    store: "",
    photo: "",
    barcode: "",
  });

  const currentList = data.currentListId ? data.lists[data.currentListId] : null;

  // Ensure one starter list
  useEffect(() => {
    if (!currentList) {
      const id = genId();
      const lists = { ...data.lists, [id]: { id, name: "My First Trip", createdAt: new Date().toISOString(), groupId: null, budget: 0, store: "", items: [] } };
      setData((d) => ({ ...d, lists, currentListId: id }));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Drag & drop ordering
  useEffect(() => {
    if (!listRef.current) return;
    const sortable = new Sortable(listRef.current, {
      handle: ".drag",
      animation: 150,
      ghostClass: "opacity-50",
      onEnd: (evt) => {
        const { oldIndex, newIndex } = evt;
        setData((d) => {
          const list = d.lists[d.currentListId];
          if (!list) return d;
          const items = [...list.items];
          const [moved] = items.splice(oldIndex, 1);
          items.splice(newIndex, 0, moved);
          return { ...d, lists: { ...d.lists, [list.id]: { ...list, items } } };
        });
      },
    });
    return () => sortable.destroy();
  }, [data.currentListId]);

  // Theme handling
  useEffect(() => {
    const theme = data.settings?.theme || "auto";
    const root = document.documentElement;
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    const dark = theme === "dark" || (theme === "auto" && prefersDark);
    root.classList.toggle("dark", !!dark);
  }, [data.settings?.theme]);

  // ---------- Derived values ----------
  const { totalQty, subtotal, tax, total } = useMemo(() => {
    const items = currentList?.items || [];
    const qty = items.reduce((s, it) => s + Number(it.quantity || 0), 0);
    const sum = items.reduce((s, it) => s + Number(it.price || 0) * Number(it.quantity || 0), 0);
    const taxable = data.settings.pricesIncludeTax ? 0 : sum * data.settings.taxRate;
    const total = data.settings.pricesIncludeTax ? sum : sum + taxable;
    return { totalQty: qty, subtotal: sum, tax: taxable, total };
  }, [currentList, data.settings]);

  const budgetProgress = useMemo(() => {
    const budget = Number(currentList?.budget || 0);
    if (!budget) return { pct: 0, over: false, remaining: 0 };
    const pct = Math.min((total / budget) * 100, 100);
    return { pct, over: total > budget, remaining: Math.max(budget - total, 0), budget };
  }, [currentList, total]);

  const frequentItems = useMemo(() => {
    const counts = new Map();
    Object.values(data.lists).forEach((l) => {
      (l.items || []).forEach((it) => {
        const key = it.name.trim().toLowerCase();
        counts.set(key, (counts.get(key) || 0) + 1);
      });
    });
    return Array.from(counts.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 8)
      .map(([name]) => name);
  }, [data.lists]);

  // ---------- Handlers ----------
  function setList(id, patch) {
    setData((d) => ({ ...d, lists: { ...d.lists, [id]: { ...d.lists[id], ...patch } } }));
  }

  function addItem(e) {
    e?.preventDefault();
    if (!currentList) return;
    const price = Number(newItem.price);
    const quantity = Number(newItem.quantity || 1);
    if (!newItem.name.trim() || isNaN(price) || isNaN(quantity) || price < 0 || quantity <= 0) return;
    const item = { id: genId(), ...newItem, price, quantity, purchased: false, createdAt: new Date().toISOString() };
    setList(currentList.id, { items: [...currentList.items, item] });
    setNewItem({ name: "", price: "", quantity: 1, unitName: "", unitSize: "", category: "", store: "", photo: "", barcode: "" });
  }

  function deleteItem(id) {
    if (!currentList) return;
    setList(
      currentList.id,
      { items: currentList.items.filter((it) => it.id !== id) }
    );
  }

  function togglePurchased(id) {
    if (!currentList) return;
    const items = currentList.items.map((it) => (it.id === id ? { ...it, purchased: !it.purchased } : it));
    setList(currentList.id, { items });
  }

  function updateItem(id, patch) {
    if (!currentList) return;
    const items = currentList.items.map((it) => (it.id === id ? { ...it, ...patch } : it));
    setList(currentList.id, { items });
  }

  function createList(name) {
    const id = genId();
    setData((d) => ({
      ...d,
      lists: { ...d.lists, [id]: { id, name, createdAt: new Date().toISOString(), groupId: null, budget: 0, store: "", items: [] } },
      currentListId: id,
    }));
  }

  function deleteList() {
    if (!currentList) return;
    if (!confirm(`Delete list "${currentList.name}"?`)) return;
    setData((d) => {
      const lists = { ...d.lists };
      delete lists[currentList.id];
      const nextId = Object.keys(lists)[0] || null;
      return { ...d, lists, currentListId: nextId };
    });
  }

  function createGroup(name) {
    const id = genId();
    setData((d) => ({ ...d, groups: { ...d.groups, [id]: { id, name } } }));
  }

  function assignListToGroup(listId, groupId) {
    setList(listId, { groupId: groupId || null });
  }

  // ---------- Barcode Scanner ----------
  useEffect(() => {
    if (!scannerOpen) return;
    let active = true;
    let scanner;
    (async () => {
      try {
        setScannerLoading(true);
        const id = "qr-reader";
        scanner = new Html5Qrcode(id);
        setHtml5Qr(scanner);
        await scanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 150 } },
          async (decoded) => {
            if (!active) return;
            // Stop quickly to avoid double fires
            try { await scanner.stop(); } catch {}
            setScannerOpen(false);
            fetchOpenFoodFacts(decoded);
          },
          () => {}
        );
      } catch (e) {
        console.error(e);
        alert("Could not start camera scanner. You can still type the item.");
        setScannerOpen(false);
      } finally {
        setScannerLoading(false);
      }
    })();
    return () => {
      active = false;
      (async () => {
        try { await scanner?.stop(); } catch {}
        try { await scanner?.clear(); } catch {}
      })();
    };
  }, [scannerOpen]);

  async function fetchOpenFoodFacts(code) {
    try {
      const r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
      const j = await r.json();
      if (j?.status === 1 && j.product) {
        const p = j.product;
        setNewItem((ni) => ({
          ...ni,
          name: p.product_name || p.generic_name || ni.name || "Unknown Product",
          photo: p.image_front_url || p.image_url || ni.photo || "",
          barcode: code,
        }));
      } else {
        alert("Barcode not found. Enter manually.");
      }
    } catch (e) {
      alert("Lookup failed. Enter manually.");
    }
  }

  // ---------- Import/Export ----------
  function download(name, content, type = "application/json") {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([content], { type }));
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportAll() {
    download("ShopTallyPro_Backup.json", JSON.stringify(data, null, 2));
  }

  function exportViewCSV() {
    const lists = Object.values(data.lists);
    let rows = [
      ["List","Item","Price","Qty","UnitSize","Unit","Category","Store","Purchased","CreatedAt","Photo","Barcode"].join(","),
    ];
    lists.forEach((l) => l.items.forEach((it) => {
      rows.push([
        esc(l.name), esc(it.name), it.price, it.quantity, esc(it.unitSize||""), esc(it.unitName||""), esc(it.category||""), esc(it.store||""), it.purchased ? 1 : 0, esc(it.createdAt||""), esc(it.photo||""), esc(it.barcode||"")
      ].join(","));
    }));
    download("ShopTallyPro_View.csv", rows.join("\r\n"), "text/csv;charset=utf-8");
  }

  function esc(s){
    const str = String(s ?? "");
    if (str.includes(",") || str.includes("\n") || str.includes('"')) {
      return '"' + str.replaceAll('"', '""') + '"';
    }
    return str;
  }

  async function importAll(file) {
    if (!file) return;
    const text = await file.text();
    try {
      const incoming = JSON.parse(text);
      if (!incoming?.lists) throw new Error("Invalid backup file");
      // Merge with ID re-mapping to avoid collisions by name
      const nameTaken = new Set(Object.values(data.lists).map((l) => l.name));
      const newLists = {};
      const idMap = new Map();
      Object.values(incoming.lists).forEach((l) => {
        let name = l.name;
        let i = 1;
        while (nameTaken.has(name)) { name = `${l.name} (Imported ${i++})`; }
        nameTaken.add(name);
        const id = genId();
        idMap.set(l.id, id);
        newLists[id] = { ...l, id, name };
      });
      const newGroups = {};
      Object.values(incoming.groups || {}).forEach((g) => {
        const id = genId();
        newGroups[id] = { id, name: g.name };
      });
      // Remap groupIds
      Object.values(newLists).forEach((l) => { l.groupId = null; });
      setData((d) => ({
        ...d,
        lists: { ...d.lists, ...newLists },
        groups: { ...d.groups, ...newGroups },
      }));
      alert("Import complete.");
    } catch (e) {
      alert("Import failed.");
    }
  }

  // ---------- Keyboard Shortcuts ----------
  useEffect(() => {
    function onKey(e){
      if (e.target.closest("input,textarea,select")) return;
      if (e.key.toLowerCase() === "n") document.getElementById("nameInput")?.focus();
      if (e.key.toLowerCase() === "s") setScannerOpen(true);
      if (e.key.toLowerCase() === "f") document.getElementById("searchInput")?.focus();
    }
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, []);

  // ---------- Filters & search ----------
  const [query, setQuery] = useState("");
  const [showOnlyUnpurchased, setShowOnlyUnpurchased] = useState(false);
  const [sortKey, setSortKey] = useState("createdAt"); // price | name | createdAt

  const visibleItems = useMemo(() => {
    let items = currentList?.items || [];
    if (query.trim()) {
      const q = query.toLowerCase();
      items = items.filter((it) => it.name.toLowerCase().includes(q) || (it.category||"").toLowerCase().includes(q));
    }
    if (showOnlyUnpurchased) items = items.filter((it) => !it.purchased);
    items = [...items];
    if (sortKey === "price") items.sort((a,b) => (a.price*a.quantity) - (b.price*b.quantity));
    if (sortKey === "name") items.sort((a,b) => a.name.localeCompare(b.name));
    if (sortKey === "createdAt") items.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
    return items;
  }, [currentList, query, showOnlyUnpurchased, sortKey]);

  // ---------- Analytics ----------
  const analytics = useMemo(() => {
    const lists = Object.values(data.lists);
    const byList = lists.map((l) => ({
      name: l.name,
      date: l.createdAt,
      total: l.items.reduce((s, it) => s + Number(it.price||0) * Number(it.quantity||0), 0),
    })).sort((a,b) => new Date(a.date) - new Date(b.date));

    const catMap = new Map();
    lists.forEach((l) => l.items.forEach((it) => catMap.set(it.category || "Uncategorized", (catMap.get(it.category || "Uncategorized")||0) + Number(it.price||0) * Number(it.quantity||0))));
    const byCat = Array.from(catMap, ([name, total]) => ({ name, total }));

    const storeMap = new Map();
    lists.forEach((l) => l.items.forEach((it) => storeMap.set(it.store || "—", (storeMap.get(it.store || "—")||0) + Number(it.price||0) * Number(it.quantity||0))));
    const byStore = Array.from(storeMap, ([name, total]) => ({ name, total }));

    return { byList, byCat, byStore };
  }, [data.lists]);

  // ---------- UI ----------
  return (
    <div className="w-full max-w-md mx-auto bg-white dark:bg-zinc-900 dark:text-zinc-100 rounded-2xl shadow-xl p-3 sm:p-4">
      {/* Header */}
      <div className="flex items-center gap-2 mb-3">
        <select
          className="flex-1 rounded-xl border px-3 py-2 bg-white dark:bg-zinc-800"
          value={data.currentListId || ""}
          onChange={(e) => setData((d) => ({ ...d, currentListId: e.target.value }))}
        >
          {Object.values(data.groups).length > 0 && (
            <optgroup label="Groups" />
          )}
          {Object.values(data.groups)
            .sort((a,b)=>a.name.localeCompare(b.name))
            .map((g) => (
              <optgroup key={g.id} label={g.name}>
                {Object.values(data.lists)
                  .filter((l) => l.groupId === g.id)
                  .sort((a,b)=>a.name.localeCompare(b.name))
                  .map((l) => (
                    <option key={l.id} value={l.id}>{l.name}</option>
                  ))}
              </optgroup>
            ))}
          <optgroup label="Ungrouped">
            {Object.values(data.lists)
              .filter((l) => !l.groupId)
              .sort((a,b)=>a.name.localeCompare(b.name))
              .map((l) => (
                <option key={l.id} value={l.id}>{l.name}</option>
              ))}
          </optgroup>
        </select>
        <button
          className="p-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700"
          onClick={() => {
            const name = prompt("New list name");
            if (name?.trim()) createList(name.trim());
          }}
          title="New List"
        >
          <Plus size={18} />
        </button>
        <button className="p-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700" onClick={deleteList} title="Delete List">
          <Trash2 size={18} />
        </button>
      </div>

      {/* Meta row */}
      <div className="flex gap-2 mb-3">
        <button className="flex-1 flex items-center justify-center gap-2 rounded-xl bg-blue-600 text-white py-2 hover:bg-blue-700" onClick={() => (document.getElementById("groupsModal").showModal())}>
          <FolderGit2 size={18} /> Groups
        </button>
        <button className="flex-1 flex items-center justify-center gap-2 rounded-xl bg-sky-600 text-white py-2 hover:bg-sky-700" onClick={() => (document.getElementById("analyticsModal").showModal())}>
          <BarChart3 size={18} /> Analytics
        </button>
        <button className="flex-1 flex items-center justify-center gap-2 rounded-xl bg-zinc-800 text-white py-2 hover:bg-zinc-900" onClick={() => (document.getElementById("settingsModal").showModal())}>
          <SettingsIcon size={18} /> Settings
        </button>
      </div>

      {/* Header analytics */}
      <div className="rounded-2xl bg-zinc-50 dark:bg-zinc-800 p-3 mb-3">
        <div className="grid grid-cols-3 text-center gap-2">
          <div>
            <div className="text-xs uppercase tracking-wide opacity-70">Items</div>
            <div className="text-lg font-semibold">{totalQty}</div>
          </div>
          <div>
            <div className="text-xs uppercase tracking-wide opacity-70">Subtotal</div>
            <div className="text-lg font-semibold">{currencyFmt(subtotal, data.settings.currency)}</div>
          </div>
          <div>
            <div className="text-xs uppercase tracking-wide opacity-70">Total</div>
            <div className={`text-lg font-semibold ${budgetProgress.over ? "text-rose-600" : ""}`}>{currencyFmt(total, data.settings.currency)}</div>
          </div>
        </div>
        {/* Budget bar */}
        <div className="mt-3">
          <div className="flex items-center justify-between text-xs mb-1 opacity-70">
            <span>Budget</span>
            <span>
              {currencyFmt(currentList?.budget || 0, data.settings.currency)}
              {currentList?.budget ? (
                <>
                  {" "}• {budgetProgress.over ? "Over by" : "Left"} {currencyFmt(budgetProgress.over ? (total - (currentList?.budget||0)) : budgetProgress.remaining, data.settings.currency)}
                </>
              ) : (
                <span className="opacity-60"> (not set)</span>
              )}
            </span>
          </div>
          <div className="h-2 rounded-full bg-zinc-200 dark:bg-zinc-700 overflow-hidden">
            <div
              className={`h-2 ${budgetProgress.over ? "bg-rose-600" : "bg-emerald-600"}`}
              style={{ width: `${budgetProgress.pct}%` }}
            />
          </div>
        </div>
        {!data.settings.pricesIncludeTax && (
          <div className="mt-2 text-xs opacity-70 flex items-center gap-2">
            <DollarSign size={14} /> Tax est.: {currencyFmt(tax, data.settings.currency)} at {(data.settings.taxRate * 100).toFixed(1)}%
          </div>
        )}
      </div>

      {/* Add item */}
      <form onSubmit={addItem} className="rounded-2xl bg-white dark:bg-zinc-800 shadow p-3 mb-3">
        <div className="flex items-center gap-2 mb-2">
          <input id="nameInput" className="flex-1 rounded-xl border px-3 py-2 bg-white dark:bg-zinc-900" placeholder="Item name" value={newItem.name} onChange={(e)=>setNewItem({...newItem,name:e.target.value})} required />
          <button type="button" className="p-2 rounded-xl bg-zinc-200 dark:bg-zinc-700" onClick={()=>setScannerOpen(true)} title="Scan barcode">
            <ScanLine size={18} />
          </button>
        </div>
        <div className="grid grid-cols-3 gap-2 mb-2">
          <input type="number" min="0" step="0.01" className="rounded-xl border px-3 py-2 bg-white dark:bg-zinc-900" placeholder="Price" value={newItem.price} onChange={(e)=>setNewItem({...newItem,price:e.target.value})} required />
          <input type="number" min="1" step="1" className="rounded-xl border px-3 py-2 bg-white dark:bg-zinc-900" placeholder="Qty" value={newItem.quantity} onChange={(e)=>setNewItem({...newItem,quantity:Number(e.target.value)})} required />
          <input className="rounded-xl border px-3 py-2 bg-white dark:bg-zinc-900" placeholder="Category" value={newItem.category} onChange={(e)=>setNewItem({...newItem,category:e.target.value})} />
        </div>
        <div className="grid grid-cols-3 gap-2 mb-2">
          <input className="rounded-xl border px-3 py-2 bg-white dark:bg-zinc-900" placeholder="Unit size (e.g., 500)" value={newItem.unitSize} onChange={(e)=>setNewItem({...newItem,unitSize:e.target.value})} />
          <input className="rounded-xl border px-3 py-2 bg-white dark:bg-zinc-900" placeholder="Unit (g, kg, L)" value={newItem.unitName} onChange={(e)=>setNewItem({...newItem,unitName:e.target.value})} />
          <input className="rounded-xl border px-3 py-2 bg-white dark:bg-zinc-900" placeholder="Store" value={newItem.store} onChange={(e)=>setNewItem({...newItem,store:e.target.value})} />
        </div>
        <div className="flex items-center gap-2">
          <label className="flex items-center gap-2 text-sm cursor-pointer">
            <Camera size={16} />
            <input type="file" accept="image/*" className="hidden" onChange={async (e)=>{
              const f = e.target.files?.[0];
              if (!f) return;
              const dataUrl = await fileToDataUrl(f);
              setNewItem((ni)=>({ ...ni, photo: dataUrl }));
            }} />
            <span>{newItem.photo ? "Change photo" : "Add photo (optional)"}</span>
          </label>
          <div className="ml-auto flex items-center gap-2">
            <button type="button" className="px-3 py-2 rounded-xl bg-zinc-200 dark:bg-zinc-700" onClick={() => (
              setNewItem({ name: "", price: "", quantity: 1, unitName: "", unitSize: "", category: "", store: "", photo: "", barcode: "" })
            )}>Clear</button>
            <button type="submit" className="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 flex items-center gap-2">
              <Plus size={16}/> Add
            </button>
          </div>
        </div>
        {frequentItems.length > 0 && (
          <div className="mt-3 text-xs">
            <div className="opacity-60 mb-1">Quick add:</div>
            <div className="flex flex-wrap gap-2">
              {frequentItems.map((n) => (
                <button key={n} type="button" className="px-2 py-1 rounded-full bg-zinc-100 dark:bg-zinc-700 hover:bg-zinc-200" onClick={()=>setNewItem((ni)=>({...ni,name:n}))}>{n}</button>
              ))}
            </div>
          </div>
        )}
      </form>

      {/* Search / Filters */}
      <div className="flex items-center gap-2 mb-2">
        <div className="flex items-center gap-2 flex-1 rounded-xl border px-2 py-1 bg-white dark:bg-zinc-800">
          <Search size={16} className="opacity-60"/>
          <input id="searchInput" className="flex-1 bg-transparent outline-none" placeholder="Search name or category" value={query} onChange={(e)=>setQuery(e.target.value)}/>
        </div>
        <select className="rounded-xl border px-2 py-2 bg-white dark:bg-zinc-800" value={sortKey} onChange={(e)=>setSortKey(e.target.value)}>
          <option value="createdAt">Newest</option>
          <option value="name">Name</option>
          <option value="price">Price</option>
        </select>
        <label className="text-sm flex items-center gap-1 cursor-pointer">
          <input type="checkbox" checked={showOnlyUnpurchased} onChange={(e)=>setShowOnlyUnpurchased(e.target.checked)} />
          Unpurchased
        </label>
      </div>

      {/* Items list */}
      <div ref={listRef} className="grid gap-2">
        {visibleItems.map((it) => {
          const perUnit = it.unitSize && it.unitName ? Number(it.price||0) / Number(it.unitSize||1) : null;
          return (
            <div className="flex items-center gap-3 rounded-2xl bg-white dark:bg-zinc-800 shadow p-2" key={it.id}>
              <button className="drag cursor-grab text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300"><GripVertical size={18}/></button>
              <button className="rounded-full p-1" onClick={()=>togglePurchased(it.id)} title={it.purchased?"Mark as needed":"Mark as purchased"}>
                {it.purchased ? <CheckCircle2 className="text-emerald-600"/> : <Circle className="text-zinc-400"/>}
              </button>
              <img src={it.photo || "https://via.placeholder.com/60"} alt="thumb" className="w-12 h-12 rounded-xl object-cover"/>
              <div className="flex-1 min-w-0">
                <div className="flex items-center justify-between">
                  <div className="truncate font-semibold">{it.name} {it.quantity>1 && <span className="opacity-70">×{it.quantity}</span>}</div>
                  <div className="font-semibold">{currencyFmt(Number(it.price)*Number(it.quantity), data.settings.currency)}</div>
                </div>
                <div className="text-xs opacity-70 flex items-center gap-2 truncate">
                  {it.category && <span className="px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-zinc-700">{it.category}</span>}
                  {it.store && <span className="px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-zinc-700">{it.store}</span>}
                  {perUnit && <span>({currencyFmt(perUnit, data.settings.currency)}/{it.unitName})</span>}
                </div>
              </div>
              <button className="p-2 rounded-xl bg-zinc-200 dark:bg-zinc-700" title="Edit" onClick={() => {
                const name = prompt("Edit name", it.name) ?? it.name;
                const price = Number(prompt("Edit price", String(it.price)) ?? it.price);
                const qty = Number(prompt("Edit quantity", String(it.quantity)) ?? it.quantity);
                if (!name.trim() || isNaN(price) || isNaN(qty) || qty<=0 || price<0) return;
                updateItem(it.id, { name: name.trim(), price, quantity: qty });
              }}>
                <Edit3 size={16}/>
              </button>
              <button className="p-2 rounded-xl bg-rose-600 text-white" title="Delete" onClick={()=>deleteItem(it.id)}>
                <Trash2 size={16}/>
              </button>
            </div>
          );
        })}
      </div>

      {/* Footer / quick actions */}
      <div className="mt-4 grid grid-cols-2 gap-2">
        <button className="flex items-center justify-center gap-2 rounded-xl bg-emerald-600 text-white py-2 hover:bg-emerald-700" onClick={()=>{
          if (!currentList) return;
          const budget = Number(prompt("Set list budget (amount)", String(currentList.budget || 0)) ?? currentList.budget);
          if (!isNaN(budget) && budget >= 0) setList(currentList.id, { budget });
        }}>
          <ShoppingCart size={18}/> Set Budget
        </button>
        <button className="flex items-center justify-center gap-2 rounded-xl bg-zinc-700 text-white py-2 hover:bg-zinc-800" onClick={()=>{
          // Mark all unpurchased as purchased
          if (!currentList) return;
          const items = currentList.items.map((it)=> it.purchased ? it : { ...it, purchased: true });
          setList(currentList.id, { items });
        }}>
          <CheckCircle2 size={18}/> Checkout All
        </button>
      </div>

      {/* Scanner Modal */}
      {scannerOpen && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className="w-full max-w-md rounded-2xl bg-white dark:bg-zinc-900 p-4">
            <div className="flex items-center justify-between mb-2">
              <div className="font-semibold flex items-center gap-2"><ScanLine size={18}/> Scan Barcode</div>
              <button className="px-2 py-1 rounded-lg bg-zinc-200 dark:bg-zinc-700" onClick={()=>setScannerOpen(false)}>Close</button>
            </div>
            <div id="qr-reader" ref={qrRef} className="rounded-xl overflow-hidden border h-56"/>
            {scannerLoading && <div className="text-center text-sm opacity-70 mt-2">Starting camera…</div>}
          </div>
        </div>
      )}

      {/* Groups Modal */}
      <dialog id="groupsModal" className="rounded-2xl p-0 w-full max-w-md bg-white dark:bg-zinc-900">
        <div className="p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="font-semibold text-lg flex items-center gap-2"><FolderGit2 size={18}/> Manage Groups</div>
            <button className="px-2 py-1 rounded-lg bg-zinc-200 dark:bg-zinc-700" onClick={()=>document.getElementById("groupsModal").close()}>Close</button>
          </div>
          <div className="flex items-center gap-2 mb-3">
            <input id="newGroupName" className="flex-1 rounded-xl border px-3 py-2 bg-white dark:bg-zinc-800" placeholder="New group name"/>
            <button className="px-3 py-2 rounded-xl bg-indigo-600 text-white" onClick={()=>{
              const name = document.getElementById("newGroupName").value.trim();
              if (!name) return;
              createGroup(name);
              document.getElementById("newGroupName").value = "";
            }}>Create</button>
          </div>
          <div className="space-y-2 max-h-80 overflow-auto">
            {Object.values(data.lists).sort((a,b)=>a.name.localeCompare(b.name)).map((l)=>(
              <div key={l.id} className="flex items-center justify-between rounded-xl border p-2">
                <div className="font-medium">{l.name}</div>
                <select className="rounded-lg border px-2 py-1 bg-white dark:bg-zinc-800" value={l.groupId || ""} onChange={(e)=>assignListToGroup(l.id, e.target.value || null)}>
                  <option value="">(Ungrouped)</option>
                  {Object.values(data.groups).sort((a,b)=>a.name.localeCompare(b.name)).map((g)=>(<option key={g.id} value={g.id}>{g.name}</option>))}
                </select>
              </div>
            ))}
          </div>
        </div>
      </dialog>

      {/* Analytics Modal */}
      <dialog id="analyticsModal" className="rounded-2xl p-0 w-full max-w-md bg-white dark:bg-zinc-900">
        <div className="p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="font-semibold text-lg flex items-center gap-2"><BarChart3 size={18}/> Analytics</div>
            <button className="px-2 py-1 rounded-lg bg-zinc-200 dark:bg-zinc-700" onClick={()=>document.getElementById("analyticsModal").close()}>Close</button>
          </div>

          <div className="space-y-6">
            <div>
              <div className="text-sm mb-1 opacity-70">Spend by list (chronological)</div>
              <div className="h-48">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={analytics.byList} margin={{ top: 8, right: 8, left: 0, bottom: 0 }}>
                    <XAxis dataKey="name" hide={false} interval={0} angle={-10} textAnchor="end" height={40}/>
                    <YAxis tickFormatter={(v)=>currencyFmt(v, data.settings.currency)} width={60} />
                    <Tooltip formatter={(v)=>currencyFmt(v, data.settings.currency)} />
                    <Line type="monotone" dataKey="total" stroke="#8e44ad" strokeWidth={2} dot={false} />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>
            <div className="grid grid-cols-1 gap-4">
              <div>
                <div className="text-sm mb-1 opacity-70">Spend by category</div>
                <div className="h-44">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie data={analytics.byCat} dataKey="total" nameKey="name" innerRadius={40} outerRadius={70}>
                        {analytics.byCat.map((_, i) => (
                          <Cell key={i} fill={COLORS[i % COLORS.length]} />
                        ))}
                      </Pie>
                      <Legend verticalAlign="bottom" height={24}/>
                      <Tooltip formatter={(v)=>currencyFmt(v, data.settings.currency)} />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
              </div>
              <div>
                <div className="text-sm mb-1 opacity-70">Spend by store</div>
                <div className="h-44">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={analytics.byStore} margin={{ top: 8, right: 8, left: 0, bottom: 0 }}>
                      <XAxis dataKey="name" interval={0} angle={-10} textAnchor="end" height={40}/>
                      <YAxis tickFormatter={(v)=>currencyFmt(v, data.settings.currency)} width={60} />
                      <Tooltip formatter={(v)=>currencyFmt(v, data.settings.currency)} />
                      <Bar dataKey="total" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>

            <div className="flex items-center justify-end gap-2">
              <button className="px-3 py-2 rounded-xl bg-zinc-200 dark:bg-zinc-700 flex items-center gap-2" onClick={exportViewCSV}>
                <Download size={16}/> Export CSV
              </button>
              <button className="px-3 py-2 rounded-xl bg-zinc-200 dark:bg-zinc-700 flex items-center gap-2" onClick={exportAll}>
                <Download size={16}/> Backup JSON
              </button>
            </div>
          </div>
        </div>
      </dialog>

      {/* Settings Modal */}
      <dialog id="settingsModal" className="rounded-2xl p-0 w-full max-w-md bg-white dark:bg-zinc-900">
        <div className="p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="font-semibold text-lg flex items-center gap-2"><SettingsIcon size={18}/> Settings & Data</div>
            <button className="px-2 py-1 rounded-lg bg-zinc-200 dark:bg-zinc-700" onClick={()=>document.getElementById("settingsModal").close()}>Close</button>
          </div>

          <div className="space-y-3">
            <div className="grid grid-cols-2 gap-2">
              <label className="text-sm">Currency
                <select className="w-full rounded-xl border px-2 py-2 bg-white dark:bg-zinc-800" value={data.settings.currency} onChange={(e)=>setData((d)=>({...d, settings:{...d.settings,currency:e.target.value}}))}>
                  {"USD,EUR,CAD,GBP,AUD,NZD,JPY,CHF,SEK".split(",").map((c)=>(<option key={c} value={c}>{c}</option>))}
                </select>
              </label>
              <label className="text-sm">Theme
                <select className="w-full rounded-xl border px-2 py-2 bg-white dark:bg-zinc-800" value={data.settings.theme} onChange={(e)=>setData((d)=>({...d, settings:{...d.settings,theme:e.target.value}}))}>
                  <option value="auto">Auto</option>
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                </select>
              </label>
            </div>
            <div className="grid grid-cols-2 gap-2">
              <label className="text-sm">Tax rate (%)
                <input type="number" min="0" step="0.01" className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-zinc-800" value={(data.settings.taxRate*100).toString()} onChange={(e)=>{
                  const v = Number(e.target.value); if (isNaN(v)||v<0) return; setData((d)=>({...d, settings:{...d.settings, taxRate: v/100}}));
                }}/>
              </label>
              <label className="text-sm flex items-center gap-2">Prices include tax?
                <input type="checkbox" checked={data.settings.pricesIncludeTax} onChange={(e)=>setData((d)=>({...d, settings:{...d.settings, pricesIncludeTax:e.target.checked}}))}/>
              </label>
            </div>

            <div className="h-px bg-zinc-200 dark:bg-zinc-700"/>

            <div className="text-sm">Data Management</div>
            <div className="flex items-center gap-2">
              <label className="px-3 py-2 rounded-xl bg-zinc-200 dark:bg-zinc-700 cursor-pointer flex items-center gap-2">
                <Upload size={16}/> Import JSON
                <input type="file" className="hidden" accept="application/json" onChange={(e)=>importAll(e.target.files?.[0])}/>
              </label>
              <button className="px-3 py-2 rounded-xl bg-zinc-200 dark:bg-zinc-700" onClick={exportAll}><Download size={16}/> Backup</button>
              <button className="px-3 py-2 rounded-xl bg-rose-600 text-white" onClick={()=>{
                if (confirm("Wipe ALL local data? This cannot be undone.")) {
                  setData(DEFAULT_STATE);
                }
              }}>Factory Reset</button>
            </div>
          </div>
        </div>
      </dialog>

      {/* Tiny credits */}
      <div className="text-[10px] text-center opacity-60 mt-4">ShopTally Pro · Local-first · v1</div>
    </div>
  );
}
