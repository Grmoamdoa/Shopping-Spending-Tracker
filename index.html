<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Shopping List v4</title>
  <meta name="theme-color" content="#8e44ad" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />

  <!-- Libraries (all free) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script defer src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

  <style>
    :root{
      --primary:#8e44ad;--secondary:#3498db;--danger:#c0392b;--bg:#f6f7fb;--panel:#ffffff;--ink:#1f2330;--muted:#70768a;--radius:14px;--shadow:0 8px 28px rgba(16,24,40,.08)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(135deg,#ede7f6,#e7f0fb); color:var(--ink); display:flex; justify-content:center; align-items:flex-start; padding:16px}

    .app{width:100%; max-width:980px; display:grid; gap:12px; grid-template-columns: 310px 1fr}

    /* Left column */
    .panel{background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow)}
    .panel header{padding:14px 16px; border-bottom:1px solid #eef0f3; display:flex; align-items:center; gap:8px}
    .panel main{padding:16px}

    select, input, button{font-size:16px}
    .btn{border:0; border-radius:12px; padding:10px 12px; background:var(--primary); color:#fff; cursor:pointer}
    .btn.secondary{background:var(--secondary)}
    .btn.ghost{background:#f2eef7; color:#5d3b76}
    .btn.danger{background:var(--danger)}
    .btn.small{padding:6px 10px; font-size:14px}

    .row{display:flex; gap:8px; align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grow{flex:1}

    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; padding:12px 16px}
    .kpi .card{background:#fff; border-radius:12px; padding:10px 12px; box-shadow:var(--shadow)}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-weight:700; font-size:18px; margin-top:2px}

    .budget{padding:0 16px 12px}
    .budget .meter{height:12px; background:#eef0f6; border-radius:999px; overflow:hidden}
    .budget .bar{height:100%; background:linear-gradient(90deg,#7c4dff,#40c4ff); width:0%}
    .budget small{display:block; color:var(--muted); margin-top:6px}

    /* Item list */
    .toolbar{padding:12px 16px; border-bottom:1px solid #eef0f3; display:flex; gap:8px}
    .search{flex:1}
    .search input{width:100%; padding:10px 12px; border:1px solid #d9dfe7; border-radius:12px}

    .items{padding:8px 16px 16px; display:grid; gap:10px}
    .item{display:grid; grid-template-columns: 26px 1fr auto; gap:10px; align-items:center; background:#fff; border-radius:12px; padding:10px 12px; box-shadow:var(--shadow)}
    .item .name{font-weight:600}
    .item .meta{font-size:13px; color:var(--muted)}
    .item .total{font-weight:700}
    .item.checked{opacity:.6}

    .toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px; border-radius:10px; display:none}
    .hidden{display:none !important}

    @media (max-width: 900px){ .app{grid-template-columns: 1fr} }
  </style>
</head>
<body>
  <div class="app" aria-live="polite">

    <!-- Left: Lists + Add Item -->
    <section class="panel" id="left">
      <header class="row wrap">
        <select id="listSelect" class="grow" aria-label="Select list"></select>
        <button id="newListBtn" class="btn small" title="Create list">Ôºã</button>
        <button id="groupsBtn" class="btn small ghost" title="Manage groups">üóÇÔ∏è</button>
        <button id="settingsBtn" class="btn small ghost" title="Settings & backup">‚öôÔ∏è</button>
        <button id="deleteListBtn" class="btn small danger" title="Delete list">üóëÔ∏è</button>
      </header>

      <main>
        <form id="addForm" class="row wrap" autocomplete="off">
          <input id="name" class="grow" placeholder="Item name" required />
          <input id="price" type="number" step="0.01" min="0" placeholder="Price" required />
          <input id="qty" type="number" min="1" value="1" placeholder="Qty" required />
          <input id="size" type="number" min="0" step="0.01" placeholder="Size (e.g., 500)" />
          <select id="unit">
            <option value="">Unit</option>
            <option>g</option><option>kg</option><option>ml</option><option>L</option><option>each</option>
          </select>
          <input id="category" placeholder="Category (e.g., Produce)" />
          <button class="btn" id="scanBtn" type="button" title="Scan barcode">üì∑</button>
          <input id="photo" type="file" accept="image/*" class="hidden" />
          <button class="btn" type="submit">Add</button>
        </form>

        <div id="scannerWrap" class="hidden" style="margin:12px 0">
          <div id="barcode-reader" style="border-radius:12px; overflow:hidden"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn danger" id="closeScanner">Close Scanner</button>
          </div>
        </div>

        <div class="kpi">
          <div class="card"><div class="label">Items</div><div id="kpiItems" class="value">0</div></div>
          <div class="card"><div class="label">Spent</div><div id="kpiSpent" class="value">$0.00</div></div>
          <div class="card"><div class="label">Avg / item</div><div id="kpiAvg" class="value">$0.00</div></div>
        </div>

        <div class="budget">
          <div class="row" style="margin-bottom:6px">
            <input id="budgetInput" class="grow" type="number" step="0.01" min="0" placeholder="Budget for this list (optional)"/>
            <button class="btn small ghost" id="saveBudget">Save</button>
          </div>
          <div class="meter" aria-label="budget usage">
            <div id="budgetBar" class="bar"></div>
          </div>
          <small id="budgetText">No budget set.</small>
        </div>

        <div class="row wrap" style="gap:6px; margin:8px 16px 0">
          <button id="undoBtn" class="btn small ghost" title="Undo">‚Ü∂ Undo</button>
          <button id="redoBtn" class="btn small ghost" title="Redo">‚Ü∑ Redo</button>
          <button id="clearCheckedBtn" class="btn small ghost" title="Remove checked">Clear checked</button>
          <button id="exportCSVBtn" class="btn small secondary" title="Export CSV">Export CSV</button>
          <button id="exportJSONBtn" class="btn small secondary" title="Export JSON">Export JSON</button>
          <label class="btn small ghost" for="importInput" title="Import JSON">Import</label>
          <input id="importInput" type="file" accept="application/json" class="hidden" />
        </div>
      </main>
    </section>

    <!-- Right: Items + Analytics -->
    <section class="panel" id="right">
      <div class="toolbar">
        <div class="search"><input id="search" placeholder="Search items‚Ä¶" /></div>
        <button id="analyticsBtn" class="btn small secondary">üìà Analytics</button>
      </div>
      <div id="items" class="items" aria-live="polite"></div>
      <div style="padding:12px 16px">
        <canvas id="chart" height="200"></canvas>
      </div>
    </section>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
  // -----------------------------
  // State & Storage
  // -----------------------------
  const STORAGE_KEY = 'shoppingAppV4';
  const VERSION = 4;
  const currency = new Intl.NumberFormat(undefined, { style:'currency', currency:'CAD' });

  let state = load();
  let undoStack = []; let redoStack = [];

  function defaultState(){
    const id = uid();
    return { version: VERSION, settings:{ currency:'CAD', taxRate:0 }, groups:{}, lists:{ [id]: {id, name:'My First List', budget:null, items:[], createdAt:new Date().toISOString(), groupId:null } }, currentListId:id };
  }

  function load(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return defaultState();
      const data = JSON.parse(raw);
      // simple migration example
      if(!data.version || data.version < VERSION){ data.version = VERSION; }
      if(!data.settings) data.settings = { currency:'CAD', taxRate:0 };
      return data;
    }catch(e){ return defaultState(); }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function snapshot(){ undoStack.push(JSON.stringify(state)); redoStack.length=0; }
  function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }

  // -----------------------------
  // DOM
  // -----------------------------
  const els = {
    listSelect: document.getElementById('listSelect'),
    newListBtn: document.getElementById('newListBtn'),
    deleteListBtn: document.getElementById('deleteListBtn'),
    groupsBtn: document.getElementById('groupsBtn'),
    settingsBtn: document.getElementById('settingsBtn'),

    addForm: document.getElementById('addForm'),
    name: document.getElementById('name'), price: document.getElementById('price'), qty: document.getElementById('qty'), size: document.getElementById('size'), unit: document.getElementById('unit'), category: document.getElementById('category'), photo: document.getElementById('photo'),

    scanBtn: document.getElementById('scanBtn'), scannerWrap: document.getElementById('scannerWrap'), closeScanner: document.getElementById('closeScanner'),

    kpiItems: document.getElementById('kpiItems'), kpiSpent: document.getElementById('kpiSpent'), kpiAvg: document.getElementById('kpiAvg'),
    budgetInput: document.getElementById('budgetInput'), saveBudget: document.getElementById('saveBudget'), budgetBar: document.getElementById('budgetBar'), budgetText: document.getElementById('budgetText'),

    undoBtn: document.getElementById('undoBtn'), redoBtn: document.getElementById('redoBtn'), clearCheckedBtn: document.getElementById('clearCheckedBtn'),
    exportCSVBtn: document.getElementById('exportCSVBtn'), exportJSONBtn: document.getElementById('exportJSONBtn'), importInput: document.getElementById('importInput'),

    analyticsBtn: document.getElementById('analyticsBtn'),
    items: document.getElementById('items'),
    search: document.getElementById('search'),
    chart: document.getElementById('chart'),
    toast: document.getElementById('toast'),
  };

  // -----------------------------
  // Init
  // -----------------------------
  init();
  function init(){
    renderLists();
    renderAll();
    bind();
    registerSW();
  }

  function bind(){
    els.newListBtn.addEventListener('click', () => {
      const name = prompt('New list name?');
      if(!name) return;
      snapshot();
      const id = uid();
      state.lists[id] = { id, name, budget:null, items:[], createdAt:new Date().toISOString(), groupId:null };
      state.currentListId = id; save(); renderLists(); renderAll();
      toast('List created');
    });

    els.deleteListBtn.addEventListener('click', () => {
      const curr = current(); if(!curr) return;
      if(!confirm(`Delete list "${curr.name}"? This cannot be undone.`)) return;
      snapshot();
      delete state.lists[curr.id];
      state.currentListId = Object.keys(state.lists)[0] || null; save(); renderLists(); renderAll();
    });

    els.listSelect.addEventListener('change', () => { state.currentListId = els.listSelect.value; save(); renderAll(); });

    els.addForm.addEventListener('submit', (e) => { e.preventDefault(); addItemFromForm(); });

    els.search.addEventListener('input', () => renderItems());

    els.saveBudget.addEventListener('click', () => { const v = parseFloat(els.budgetInput.value); snapshot(); current().budget = Number.isFinite(v) ? v : null; save(); renderBudget(); toast('Budget updated'); });

    els.undoBtn.addEventListener('click', () => { if(!undoStack.length) return; redoStack.push(JSON.stringify(state)); state = JSON.parse(undoStack.pop()); save(); renderAll(); });
    els.redoBtn.addEventListener('click', () => { if(!redoStack.length) return; undoStack.push(JSON.stringify(state)); state = JSON.parse(redoStack.pop()); save(); renderAll(); });

    els.clearCheckedBtn.addEventListener('click', () => {
      snapshot();
      const curr = current(); if(!curr) return;
      curr.items = curr.items.filter(i => !i.checked); save(); renderAll();
    });

    els.exportCSVBtn.addEventListener('click', exportCSV);
    els.exportJSONBtn.addEventListener('click', exportJSON);
    els.importInput.addEventListener('change', importJSON);

    els.scanBtn.addEventListener('click', startScanner);
    els.closeScanner.addEventListener('click', stopScanner);
  }

  function registerSW(){
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  }

  // -----------------------------
  // Render
  // -----------------------------
  function current(){ return state.lists[state.currentListId] || null; }

  function renderLists(){
    const sel = els.listSelect; sel.innerHTML = '';
    Object.values(state.lists).sort((a,b)=>a.name.localeCompare(b.name)).forEach(l=>{
      const opt = document.createElement('option'); opt.value = l.id; opt.textContent = l.name; if(l.id===state.currentListId) opt.selected = true; sel.appendChild(opt);
    });
    els.deleteListBtn.style.display = Object.keys(state.lists).length ? 'inline-block' : 'none';
  }

  function renderAll(){
    renderItems();
    renderKPIs();
    renderBudget();
    drawChart();
  }

  function renderItems(){
    const list = current(); if(!list){ els.items.innerHTML = ''; return; }
    const q = els.search.value?.toLowerCase().trim() || '';
    els.items.innerHTML = '';

    const container = els.items;
    list.items.filter(i => !q || i.name.toLowerCase().includes(q) || (i.category||'').toLowerCase().includes(q))
      .forEach(item => container.appendChild(itemRow(item)));

    // enable drag reorder
    new Sortable(container,{ handle: '.drag', animation:150, onEnd: ({oldIndex,newIndex})=>{
      if(oldIndex===newIndex) return; snapshot();
      const [moved] = list.items.splice(oldIndex,1); list.items.splice(newIndex,0,moved); save();
    }});
  }

  function itemRow(item){
    const row = document.createElement('div'); row.className = 'item'+(item.checked?' checked':'');

    const check = document.createElement('input'); check.type='checkbox'; check.checked=!!item.checked; check.title='Mark purchased';
    check.addEventListener('change',()=>{ snapshot(); item.checked = check.checked; save(); renderKPIs(); renderBudget(); });

    const info = document.createElement('div');
    const title = document.createElement('div'); title.className='name'; title.textContent = item.name + (item.qty>1?` (x${item.qty})`:'' );
    const meta = document.createElement('div'); meta.className='meta';
    const u = unitText(item);
    meta.textContent = [ item.category || null, u ? `${currency.format(item.price / item.qty)} each` : null, u ? `${perUnit(item)} / ${item.unit}` : null ].filter(Boolean).join(' ‚Ä¢ ');
    info.appendChild(title); info.appendChild(meta);

    const total = document.createElement('div'); total.className='total'; total.textContent = currency.format(item.price * item.qty);

    const actions = document.createElement('div'); actions.className='row';
    const drag = document.createElement('button'); drag.className='btn small ghost drag'; drag.textContent='‚†ø'; drag.title='Drag to reorder';
    const edit = document.createElement('button'); edit.className='btn small ghost'; edit.textContent='‚úèÔ∏è'; edit.title='Edit';
    const del = document.createElement('button'); del.className='btn small danger'; del.textContent='üóëÔ∏è'; del.title='Delete';
    actions.appendChild(drag); actions.appendChild(edit); actions.appendChild(del);

    edit.addEventListener('click',()=>{
      const name = prompt('Name', item.name); if(!name) return;
      const price = parseFloat(prompt('Price', String(item.price))||''); if(!Number.isFinite(price)) return;
      const qty = parseInt(prompt('Quantity', String(item.qty))||'1',10) || 1;
      const size = parseFloat(prompt('Size (e.g., 500)', String(item.size||''))||'')||null;
      const unit = prompt('Unit (g, kg, ml, L, each)', item.unit||'')||'';
      const category = prompt('Category', item.category||'')||'';
      snapshot(); Object.assign(item,{name,price,qty,size,unit,category}); save(); renderAll();
    });
    del.addEventListener('click',()=>{ if(!confirm(`Delete ${item.name}?`))return; snapshot(); removeItem(item.id); save(); renderAll(); });

    row.appendChild(check); row.appendChild(info); row.appendChild(total); row.appendChild(actions);
    return row;
  }

  function renderKPIs(){
    const list = current(); if(!list){ els.kpiItems.textContent='0'; els.kpiSpent.textContent=currency.format(0); els.kpiAvg.textContent=currency.format(0); return; }
    const itemsCount = list.items.reduce((a,i)=>a+i.qty,0);
    const spent = list.items.reduce((a,i)=>a+(i.price*i.qty),0);
    els.kpiItems.textContent = itemsCount;
    els.kpiSpent.textContent = currency.format(spent);
    els.kpiAvg.textContent = itemsCount? currency.format(spent/itemsCount) : currency.format(0);
  }

  function renderBudget(){
    const list = current(); if(!list){ els.budgetBar.style.width='0%'; els.budgetText.textContent='No budget set.'; return; }
    els.budgetInput.value = list.budget ?? '';
    if(!list.budget){ els.budgetBar.style.width='0%'; els.budgetText.textContent='No budget set.'; return; }
    const spent = list.items.reduce((a,i)=>a+(i.price*i.qty),0);
    const pct = Math.min(100, Math.round((spent/list.budget)*100));
    els.budgetBar.style.width = pct + '%';
    els.budgetBar.style.background = pct<80? 'linear-gradient(90deg,#7c4dff,#40c4ff)' : (pct<100? 'linear-gradient(90deg,#ffb300,#ff7043)': 'linear-gradient(90deg,#e53935,#b71c1c)');
    els.budgetText.textContent = `${currency.format(spent)} / ${currency.format(list.budget)} (${pct}%)`;
  }

  function drawChart(){
    const list = current(); if(!list) return;
    const byCat = {};
    list.items.forEach(i=>{ const key=(i.category||'Uncategorized'); byCat[key]=(byCat[key]||0)+(i.price*i.qty); });
    const labels = Object.keys(byCat); const data = Object.values(byCat);
    if(window._chart) window._chart.destroy();
    const ctx = els.chart.getContext('2d');
    window._chart = new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{ label:'Spend by Category', data }] }, options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } } });
  }

  // -----------------------------
  // Add / Remove / Export
  // -----------------------------
  function addItemFromForm(){
    const name = els.name.value.trim();
    const price = parseFloat(els.price.value);
    const qty = parseInt(els.qty.value,10) || 1;
    const size = parseFloat(els.size.value) || null;
    const unit = els.unit.value.trim();
    const category = els.category.value.trim();
    if(!name || !Number.isFinite(price) || price<0) return toast('Please enter a valid name and price');
    snapshot();
    current().items.push({ id:uid(), name, price, qty, size, unit, category, checked:false, createdAt:new Date().toISOString() });
    save();
    els.addForm.reset();
    renderAll();
  }

  function removeItem(id){ const list=current(); list.items = list.items.filter(i=>i.id!==id); }

  function exportCSV(){
    const list=current(); if(!list) return;
    let csv = 'List,Item,Price,Qty,Size,Unit,Category,Checked\r\n';
    list.items.forEach(i=>{ csv += `"${list.name}","${i.name}",${i.price},${i.qty},${i.size??''},"${i.unit??''}","${i.category??''}",${i.checked?'Y':'N'}\r\n`; });
    download(`SmartShop_${list.name.replace(/\W+/g,'_')}.csv`, csv, 'text/csv;charset=utf-8;');
  }
  function exportJSON(){ download('SmartShop_Backup.json', JSON.stringify(state,null,2), 'application/json'); }
  function importJSON(e){ const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(!data.lists) throw new Error(); snapshot(); mergeImport(data); save(); renderLists(); renderAll(); toast('Import OK'); } catch{ toast('Import failed. Invalid file.'); } finally{ e.target.value=''; } }; r.readAsText(file); }

  function mergeImport(data){
    // merge groups (names must be unique)
    // simplified: we only merge lists + items
    Object.values(data.lists).forEach(l=>{
      const newId = uid();
      const name = uniqueName(l.name, Object.values(state.lists).map(x=>x.name));
      state.lists[newId] = { ...l, id:newId, name };
    });
  }
  function uniqueName(name, existing){ let n=name, k=1; while(existing.includes(n)) n = `${name} (Imported ${k++})`; return n; }

  function download(name, content, type){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

  // -----------------------------
  // Helpers
  // -----------------------------
  function unitText(i){ return (i.size && i.unit) ? `${i.size} ${i.unit}` : ''; }
  function perUnit(i){ if(!(i.size && i.unit)) return ''; return currency.format((i.price*i.qty)/i.size); }

  function toast(msg){ els.toast.textContent = msg; els.toast.style.display='block'; clearTimeout(window._t); window._t=setTimeout(()=>els.toast.style.display='none', 1600); }

  // -----------------------------
  // Barcode (optional online lookup)
  // -----------------------------
  let qr = null;
  function startScanner(){
    els.addForm.classList.add('hidden'); els.scannerWrap.classList.remove('hidden');
    const config = { fps:10, qrbox:{ width:260, height:160 } };
    if(!qr) qr = new Html5Qrcode('barcode-reader');
    qr.start({ facingMode:'environment' }, config, (decoded)=>{ stopScanner(); lookupBarcode(decoded); }, ()=>{}).catch(()=>{ toast('Could not start camera'); stopScanner(); });
  }
  function stopScanner(){ if(!qr) { els.scannerWrap.classList.add('hidden'); els.addForm.classList.remove('hidden'); return; }
    qr.stop().then(()=>{ els.scannerWrap.classList.add('hidden'); els.addForm.classList.remove('hidden'); }).catch(()=>{ els.scannerWrap.classList.add('hidden'); els.addForm.classList.remove('hidden'); });
  }
  async function lookupBarcode(code){
    toast('Searching barcode‚Ä¶');
    try{
      const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
      const j = await res.json();
      if(j.status===1 && j.product){ const p=j.product; els.name.value = p.product_name || p.generic_name || 'Unknown Product'; }
      toast('Product populated');
    }catch{ toast('No match / offline'); }
  }
  </script>
</body>
</html>
