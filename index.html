<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shopping List V3 - Stage 3</title>
    <!-- [V3 Stage 3] Add libraries for drag-drop and barcode scanning -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --danger-color: #c0392b;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --background-gradient: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            --white: #ffffff;
            --light-gray: #f0f0f0;
            --dark-gray: #333333;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: var(--background-gradient);
            color: var(--dark-gray);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 15px;
            box-sizing: border-box;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        header {
            background: var(--white);
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .header-row:not(:last-child) { margin-bottom: 10px; }
        #list-selector { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); font-size: 16px; }

        .btn { padding: 10px 15px; border: none; border-radius: var(--border-radius); background: var(--primary-color); color: var(--white); cursor: pointer; font-size: 16px; transition: background 0.3s; flex-shrink: 0; }
        .btn:hover { background: #732d91; }
        .btn-secondary { background: var(--secondary-color); }
        .btn-secondary:hover { background: #2980b9; }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #a5281b; }
        .btn-small { padding: 5px 10px; font-size: 14px; }
        .icon-btn { padding: 8px; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center; }

        .analytics-header { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; background: rgba(255,255,255,0.5); }
        .metric { font-size: 14px; }
        .metric span { display: block; font-weight: bold; font-size: 18px; }

        main { padding: 20px; }
        
        /* [V3 Stage 3] Barcode Scanner UI */
        #barcode-scanner-container { display: none; margin-bottom: 15px; }
        #barcode-reader { border: 2px solid #ddd; border-radius: var(--border-radius); }

        .add-item-form { background: var(--white); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--shadow); }
        .form-row { display: flex; gap: 10px; align-items: center; }
        .form-group { margin-bottom: 15px; flex-grow: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); box-sizing: border-box; }
        #photo-preview { max-width: 100px; margin-top: 10px; border-radius: var(--border-radius); display: none; }

        #item-list { display: grid; gap: 15px; }
        .item-card { background: var(--white); padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; position: relative; }
        .item-card .drag-handle { cursor: grab; font-size: 24px; color: #ccc; padding-right: 5px; }
        .item-card .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #e0c8ee; }
        .sortable-chosen { box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

        .item-card img { width: 60px; height: 60px; border-radius: var(--border-radius); object-fit: cover; }
        .item-info { flex-grow: 1; }
        .item-info h3 { margin: 0; font-size: 18px; }
        .item-info p { margin: 5px 0 0; font-size: 16px; color: var(--primary-color); font-weight: bold; }
        .item-actions { display: flex; gap: 5px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--light-gray); padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); position: relative; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); box-sizing: border-box; margin-bottom: 15px; }
        .modal-footer { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; display:flex; gap: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="header-row">
                <select id="list-selector"></select>
                <button class="btn icon-btn" id="new-list-btn" title="New List">+</button>
                <button class="btn btn-danger icon-btn" id="delete-list-btn" title="Delete Selected List">üóëÔ∏è</button>
            </div>
            <div class="header-row">
                <button class="btn btn-secondary btn-small" id="manage-groups-btn">üóÇÔ∏è Groups</button>
                <button class="btn btn-secondary btn-small" id="global-analytics-btn">üìà Analytics</button>
                <button class="btn btn-secondary btn-small" id="settings-btn">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <div class="analytics-header">
            <div class="metric">Total Items <span id="total-items">0</span></div>
            <div class="metric">Total Spent <span id="total-spent">$0.00</span></div>
            <div class="metric">Avg. Price <span id="avg-price">$0.00</span></div>
        </div>

        <main>
            <!-- [V3 Stage 3] Barcode Scanner will appear here -->
            <div id="barcode-scanner-container">
                <div id="barcode-reader"></div>
                <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" id="close-scanner-btn">Close Scanner</button>
            </div>

            <form class="add-item-form" id="add-item-form">
                <div class="form-row">
                    <div class="form-group" style="flex-grow: 4;">
                        <label for="item-name">Item Name</label>
                        <input type="text" id="item-name" required>
                    </div>
                    <!-- [V3 Stage 3] Barcode Scan Button -->
                    <div class="form-group">
                         <label>¬†</label>
                        <button type="button" class="btn icon-btn" id="scan-barcode-btn" title="Scan Barcode">üì∑</button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="item-price">Price</label>
                        <input type="number" id="item-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="item-quantity">Quantity</label>
                        <input type="number" id="item-quantity" value="1" min="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="item-photo">Price Tag Photo (Optional)</label>
                    <input type="file" id="item-photo" accept="image/*">
                    <img id="photo-preview" src="" alt="Photo Preview">
                </div>
                <button type="submit" class="btn" style="width: 100%;">Add Item</button>
            </form>

            <h2 id="current-list-title"></h2>
            <div id="item-list"></div>
        </main>
    </div>

    <!-- MODALS (omitted for brevity, same as Stage 2) -->
    <div id="new-list-modal" class="modal">...</div>
    <div id="edit-item-modal" class="modal">...</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State ---
        let appData = { lists: {}, groups: {}, currentListId: null };
        let sortableInstance = null;
        let html5QrCode = null; // [V3 Stage 3]

        // --- DOM Elements ---
        const listSelector = document.getElementById('list-selector');
        const currentListTitle = document.getElementById('current-list-title');
        const itemListEl = document.getElementById('item-list');
        const addItemForm = document.getElementById('add-item-form');
        // (Other DOM elements are selected but omitted here for brevity)
        const totalItemsEl = document.getElementById('total-items');
        const totalSpentEl = document.getElementById('total-spent');
        const avgPriceEl = document.getElementById('avg-price');
        const newListModal = document.getElementById('new-list-modal');
        const newListBtn = document.getElementById('new-list-btn');
        const createListBtn = document.getElementById('create-list-btn');
        const deleteListBtn = document.getElementById('delete-list-btn');
        const editItemModal = document.getElementById('edit-item-modal');
        const saveItemChangesBtn = document.getElementById('save-item-changes-btn');
        const editItemIdInput = document.getElementById('edit-item-id');
        const editItemNameInput = document.getElementById('edit-item-name');
        const editItemPriceInput = document.getElementById('edit-item-price');
        const editItemQuantityInput = document.getElementById('edit-item-quantity');
        const editItemPhotoInput = document.getElementById('edit-item-photo');
        const editPhotoPreview = document.getElementById('edit-photo-preview');
        
        // [V3 Stage 3] Barcode scanner elements
        const scannerContainer = document.getElementById('barcode-scanner-container');
        const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
        const closeScannerBtn = document.getElementById('close-scanner-btn');

        // --- Data Functions ---
        const loadData = () => { if (localStorage.getItem('shoppingAppV3')) appData = JSON.parse(localStorage.getItem('shoppingAppV3')); };
        const saveData = () => localStorage.setItem('shoppingAppV3', JSON.stringify(appData));
        const generateId = () => Date.now().toString();

        // --- Initialization ---
        function initialize() {
            loadData();
            if (Object.keys(appData.lists).length === 0) {
                const firstListId = generateId();
                appData.lists[firstListId] = { id: firstListId, name: "My First List", items: [], createdAt: new Date().toISOString(), groupId: null, budget: null };
                appData.currentListId = firstListId;
                saveData();
            }
            appData.currentListId = appData.currentListId || Object.keys(appData.lists)[0] || null;
            
            html5QrCode = new Html5Qrcode("barcode-reader"); // [V3 Stage 3]
            
            setupEventListeners();
            initializeSortable();
            renderUI();
        }

        // --- UI Rendering ---
        function renderUI() {
            const currentList = appData.lists[appData.currentListId];
            currentListTitle.textContent = currentList ? currentList.name : "No list selected";
            if (!currentList) itemListEl.innerHTML = '';
            renderListSelector();
            renderItems();
            updateHeaderAnalytics();
        }

        function renderListSelector() {
            listSelector.innerHTML = '';
            Object.values(appData.lists).sort((a,b) => a.name.localeCompare(b.name)).forEach(list => {
                const option = document.createElement('option');
                option.value = list.id; option.textContent = list.name;
                if (list.id === appData.currentListId) option.selected = true;
                listSelector.appendChild(option);
            });
        }
        
        function renderItems() {
            itemListEl.innerHTML = '';
            const currentList = appData.lists[appData.currentListId];
            if (!currentList) return;
            currentList.items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card'; itemCard.dataset.id = item.id;
                const quantityText = item.quantity > 1 ? ` (x${item.quantity})` : '';
                itemCard.innerHTML = `<span class="drag-handle" title="Drag to reorder">‚†ø</span><img src="${item.photo || 'https://via.placeholder.com/60'}" alt="${item.name}"><div class="item-info"><h3>${item.name}${quantityText}</h3><p>$${(parseFloat(item.price) * item.quantity).toFixed(2)}</p></div><div class="item-actions"><button class="btn icon-btn btn-secondary edit-item-btn" title="Edit Item">‚úèÔ∏è</button><button class="btn icon-btn btn-danger delete-item-btn" title="Delete Item">üóëÔ∏è</button></div>`;
                itemListEl.appendChild(itemCard);
            });
        }
        
        function updateHeaderAnalytics() {
            // ... (Same as Stage 2, omitted for brevity)
        }

        // --- Event Listener & Initializer Setup ---
        function setupEventListeners() {
            listSelector.addEventListener('change', () => { appData.currentListId = listSelector.value; saveData(); renderUI(); });
            addItemForm.addEventListener('submit', handleAddItem);
            document.querySelectorAll('.modal .close-btn').forEach(btn => { btn.addEventListener('click', (e) => e.target.closest('.modal').style.display = 'none'); });
            newListBtn.addEventListener('click', () => { document.getElementById('new-list-modal').style.display = 'flex'; });
            createListBtn.addEventListener('click', handleCreateList);
            deleteListBtn.addEventListener('click', handleDeleteList);
            itemListEl.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-item-btn');
                const editBtn = e.target.closest('.edit-item-btn');
                if (deleteBtn) handleDeleteItem(e.target.closest('.item-card').dataset.id);
                if (editBtn) openEditItemModal(e.target.closest('.item-card').dataset.id);
            });
            saveItemChangesBtn.addEventListener('click', handleSaveChanges);
            editItemPhotoInput.addEventListener('change', handlePhotoPreview);
            document.getElementById('item-photo').addEventListener('change', handlePhotoPreview);
            
            // [V3 Stage 3] Barcode scanner listeners
            scanBarcodeBtn.addEventListener('click', startScanner);
            closeScannerBtn.addEventListener('click', stopScanner);
        }
        
        function initializeSortable() {
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(itemListEl, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', onEnd: handleItemDragEnd });
        }

        // --- Event Handlers (omitting unchanged ones like handleCreateList, handleDeleteList, etc.) ---
        function handleAddItem(e) { /* Same as Stage 2 */ }
        function handleDeleteItem(itemId) { /* Same as Stage 2 */ }
        function openEditItemModal(itemId) { /* Same as Stage 2 */ }
        function handleSaveChanges() { /* Same as Stage 2 */ }
        function handleItemDragEnd(evt) { /* Same as Stage 2 */ }
        function handlePhotoPreview(event) { /* Same as Stage 2 */ }
        
        // [V3 Stage 3] Barcode Scanner Functions
        function startScanner() {
            addItemForm.style.display = 'none';
            scannerContainer.style.display = 'block';

            const config = { fps: 10, qrbox: { width: 250, height: 150 } };
            const onScanSuccess = (decodedText, decodedResult) => {
                stopScanner();
                fetchProductInfo(decodedText);
            };
            const onScanFailure = (error) => { /* console.log(`Scan error: ${error}`); */ };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => {
                    alert("Could not start scanner. Please grant camera permissions.");
                    stopScanner();
                });
        }
        
        function stopScanner() {
            html5QrCode.stop().then(ignore => {
                scannerContainer.style.display = 'none';
                addItemForm.style.display = 'block';
            }).catch(err => {
                 scannerContainer.style.display = 'none';
                 addItemForm.style.display = 'block';
            });
        }
        
        async function fetchProductInfo(barcode) {
            alert(`Fetching info for barcode: ${barcode}...`);
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                if (!response.ok) { throw new Error('Network response was not ok.'); }
                const data = await response.json();
                
                if (data.status === 1) {
                    const product = data.product;
                    document.getElementById('item-name').value = product.product_name || '';
                    if (product.image_front_url) {
                        const preview = document.getElementById('photo-preview');
                        preview.src = product.image_front_url;
                        preview.style.display = 'block';
                    }
                    alert("Product found!");
                } else {
                    alert("Product not found in the database.");
                }
            } catch (error) {
                console.error("Fetch error:", error);
                alert("Could not fetch product information.");
            }
        }

        // --- Start the App ---
        initialize();
    });
    </script>
</body>
</html>
