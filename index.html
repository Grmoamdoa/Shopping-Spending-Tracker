<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shopping List V3 - Stage 3 (Corrected)</title>
    <!-- V3 Library Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --danger-color: #c0392b;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --background-gradient: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            --white: #ffffff;
            --light-gray: #f0f0f0;
            --dark-gray: #333333;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: var(--background-gradient);
            color: var(--dark-gray);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 15px;
            box-sizing: border-box;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        header {
            background: var(--white);
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .header-row:not(:last-child) { margin-bottom: 10px; }
        #list-selector { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); font-size: 16px; }

        .btn { padding: 10px 15px; border: none; border-radius: var(--border-radius); background: var(--primary-color); color: var(--white); cursor: pointer; font-size: 16px; transition: background 0.3s; flex-shrink: 0; }
        .btn:hover { background: #732d91; }
        .btn-secondary { background: var(--secondary-color); }
        .btn-secondary:hover { background: #2980b9; }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #a5281b; }
        .btn-small { padding: 5px 10px; font-size: 14px; }
        .icon-btn { padding: 8px; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center; }

        .analytics-header { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; background: rgba(255,255,255,0.5); }
        .metric { font-size: 14px; }
        .metric span { display: block; font-weight: bold; font-size: 18px; }

        main { padding: 20px; }
        
        /* [V3 Stage 3] Barcode Scanner UI */
        #barcode-scanner-container { display: none; margin-bottom: 15px; }
        #barcode-reader { border: 2px solid #ddd; border-radius: var(--border-radius); }

        .add-item-form { background: var(--white); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--shadow); }
        .form-row { display: flex; gap: 10px; align-items: center; }
        .form-group { margin-bottom: 15px; flex-grow: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); box-sizing: border-box; }
        #photo-preview { max-width: 100px; margin-top: 10px; border-radius: var(--border-radius); display: none; }

        #item-list { display: grid; gap: 15px; }
        .item-card { background: var(--white); padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; position: relative; }
        /* [V3 Stage 2] Drag-and-Drop Styling */
        .item-card .drag-handle { cursor: grab; font-size: 24px; color: #ccc; padding-right: 5px; }
        .item-card .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #e0c8ee; }
        .sortable-chosen { box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

        .item-card img { width: 60px; height: 60px; border-radius: var(--border-radius); object-fit: cover; }
        .item-info { flex-grow: 1; }
        .item-info h3 { margin: 0; font-size: 18px; }
        .item-info p { margin: 5px 0 0; font-size: 16px; color: var(--primary-color); font-weight: bold; }
        .item-actions { display: flex; gap: 5px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--light-gray); padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); position: relative; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); box-sizing: border-box; margin-bottom: 15px; }
        .modal-footer { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; display:flex; gap: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="header-row">
                <select id="list-selector"></select>
                <button class="btn icon-btn" id="new-list-btn" title="New List">+</button>
                <button class="btn btn-danger icon-btn" id="delete-list-btn" title="Delete Selected List">üóëÔ∏è</button>
            </div>
            <div class="header-row">
                <button class="btn btn-secondary btn-small" id="manage-groups-btn">üóÇÔ∏è Groups</button>
                <button class="btn btn-secondary btn-small" id="global-analytics-btn">üìà Analytics</button>
                <button class="btn btn-secondary btn-small" id="settings-btn">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <div class="analytics-header">
            <div class="metric">Total Items <span id="total-items">0</span></div>
            <div class="metric">Total Spent <span id="total-spent">$0.00</span></div>
            <div class="metric">Avg. Price <span id="avg-price">$0.00</span></div>
        </div>

        <main>
            <!-- [V3 Stage 3] Barcode Scanner will appear here -->
            <div id="barcode-scanner-container">
                <div id="barcode-reader"></div>
                <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" id="close-scanner-btn">Close Scanner</button>
            </div>

            <form class="add-item-form" id="add-item-form">
                <div class="form-row">
                    <div class="form-group" style="flex-grow: 4;">
                        <label for="item-name">Item Name</label>
                        <input type="text" id="item-name" required>
                    </div>
                    <!-- [V3 Stage 3] Barcode Scan Button -->
                    <div class="form-group">
                         <label>¬†</label>
                        <button type="button" class="btn icon-btn" id="scan-barcode-btn" title="Scan Barcode">üì∑</button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="item-price">Price</label>
                        <input type="number" id="item-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="item-quantity">Quantity</label>
                        <input type="number" id="item-quantity" value="1" min="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="item-photo">Price Tag Photo (Optional)</label>
                    <input type="file" id="item-photo" accept="image/*">
                    <img id="photo-preview" src="" alt="Photo Preview">
                </div>
                <button type="submit" class="btn" style="width: 100%;">Add Item</button>
            </form>

            <h2 id="current-list-title"></h2>
            <div id="item-list"></div>
        </main>
    </div>

    <!-- MODALS -->
    <!-- New List Modal -->
    <div id="new-list-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Create New List</h2><span class="close-btn">√ó</span></div>
            <div class="modal-body">
                <input type="text" id="new-list-name" placeholder="e.g., Weekly Groceries">
            </div>
            <div class="modal-footer">
                <button class="btn" id="create-list-btn" style="width:100%;">Create List</button>
            </div>
        </div>
    </div>

    <!-- [V3] Edit Item Modal -->
    <div id="edit-item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Item</h2><span class="close-btn">√ó</span></div>
            <div class="modal-body">
                <input type="hidden" id="edit-item-id">
                <div class="form-group"><label for="edit-item-name">Item Name</label><input type="text" id="edit-item-name" required></div>
                <div class="form-row">
                    <div class="form-group"><label for="edit-item-price">Price</label><input type="number" id="edit-item-price" step="0.01" min="0" required></div>
                    <div class="form-group"><label for="edit-item-quantity">Quantity</label><input type="number" id="edit-item-quantity" min="1" required></div>
                </div>
                <div class="form-group">
                    <label for="edit-item-photo">Change Photo</label>
                    <input type="file" id="edit-item-photo" accept="image/*">
                    <img id="edit-photo-preview" src="" style="max-width:100px; margin-top:10px; border-radius: var(--border-radius);">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="save-item-changes-btn" style="width:100%;">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Placeholder Modals (Not yet functional but needed for full HTML structure) -->
    <div id="manage-groups-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Manage Groups</h2><span class="close-btn">√ó</span></div><div class="modal-body"></div></div></div>
    <div id="global-analytics-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Global Analytics</h2><span class="close-btn">√ó</span></div><div class="modal-body"></div></div></div>
    <div id="settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Settings & Data</h2><span class="close-btn">√ó</span></div><div class="modal-body"></div></div></div>
    <div id="analytics-filter-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Filter Analytics Data</h2><span class="close-btn">√ó</span></div><div class="modal-body"></div></div></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State ---
        let appData = { lists: {}, groups: {}, currentListId: null };
        let sortableInstance = null;
        let html5QrCode = null; // [V3 Stage 3] Instance for the barcode scanner

        // --- DOM Elements ---
        const listSelector = document.getElementById('list-selector');
        const currentListTitle = document.getElementById('current-list-title');
        const itemListEl = document.getElementById('item-list');
        const addItemForm = document.getElementById('add-item-form');
        
        // Header Analytics
        const totalItemsEl = document.getElementById('total-items');
        const totalSpentEl = document.getElementById('total-spent');
        const avgPriceEl = document.getElementById('avg-price');
        
        // Modals & Buttons
        const newListModal = document.getElementById('new-list-modal');
        const newListBtn = document.getElementById('new-list-btn');
        const createListBtn = document.getElementById('create-list-btn');
        const deleteListBtn = document.getElementById('delete-list-btn');
        const editItemModal = document.getElementById('edit-item-modal');
        const saveItemChangesBtn = document.getElementById('save-item-changes-btn');
        const editItemIdInput = document.getElementById('edit-item-id');
        const editItemNameInput = document.getElementById('edit-item-name');
        const editItemPriceInput = document.getElementById('edit-item-price');
        const editItemQuantityInput = document.getElementById('edit-item-quantity');
        const editItemPhotoInput = document.getElementById('edit-item-photo');
        const editPhotoPreview = document.getElementById('edit-photo-preview');
        
        // [V3] New V3 Header Buttons (not yet functional)
        const manageGroupsBtn = document.getElementById('manage-groups-btn');
        const globalAnalyticsBtn = document.getElementById('global-analytics-btn');
        const settingsBtn = document.getElementById('settings-btn');

        // [V3 Stage 3] Barcode scanner elements
        const scannerContainer = document.getElementById('barcode-scanner-container');
        const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
        const closeScannerBtn = document.getElementById('close-scanner-btn');
        const photoPreview = document.getElementById('photo-preview'); // For new item form

        // --- Data Functions ---
        function loadData() {
            const savedData = localStorage.getItem('shoppingAppV3');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
        }

        function saveData() {
            localStorage.setItem('shoppingAppV3', JSON.stringify(appData));
        }
        
        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9); // More robust ID
        }

        // --- Initialization ---
        function initialize() {
            loadData();
            // Ensure at least one list exists
            if (Object.keys(appData.lists).length === 0) {
                const firstListId = generateId();
                appData.lists[firstListId] = {
                    id: firstListId,
                    name: "My First List",
                    items: [],
                    createdAt: new Date().toISOString(),
                    groupId: null,
                    budget: null
                };
                appData.currentListId = firstListId;
                saveData();
            }
            // If currentListId is somehow invalid, reset it to the first available list
            if (!appData.currentListId || !appData.lists[appData.currentListId]) {
                 appData.currentListId = Object.keys(appData.lists)[0] || null;
            }
            
            // [V3 Stage 3] Initialize Html5Qrcode
            html5QrCode = new Html5Qrcode("barcode-reader");
            
            setupEventListeners();
            initializeSortable();
            renderUI();
        }

        // --- UI Rendering ---
        function renderUI() {
            const currentList = appData.lists[appData.currentListId];
            if (currentList) {
                currentListTitle.textContent = currentList.name;
            } else {
                currentListTitle.textContent = "No list selected";
                itemListEl.innerHTML = ''; // Clear items if no list
            }
            renderListSelector();
            renderItems();
            updateHeaderAnalytics();
        }

        function renderListSelector() {
            listSelector.innerHTML = '';
            // Sort lists alphabetically by name
            Object.values(appData.lists)
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(list => {
                    const option = document.createElement('option');
                    option.value = list.id;
                    option.textContent = list.name;
                    if (list.id === appData.currentListId) {
                        option.selected = true;
                    }
                    listSelector.appendChild(option);
            });
            // Ensure delete button is visible only if lists exist
            deleteListBtn.style.display = Object.keys(appData.lists).length > 0 ? 'flex' : 'none';
        }
        
        function renderItems() {
            itemListEl.innerHTML = '';
            const currentList = appData.lists[appData.currentListId];
            if (!currentList) return;

            currentList.items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.dataset.id = item.id; // Store item ID for easy lookup
                
                const quantityText = item.quantity > 1 ? ` (x${item.quantity})` : '';
                itemCard.innerHTML = `
                    <span class="drag-handle" title="Drag to reorder">‚†ø</span>
                    <img src="${item.photo || 'https://via.placeholder.com/60'}" alt="${item.name}">
                    <div class="item-info">
                        <h3>${item.name}${quantityText}</h3>
                        <p>$${(parseFloat(item.price) * item.quantity).toFixed(2)}</p>
                    </div>
                    <div class="item-actions">
                        <button class="btn icon-btn btn-secondary edit-item-btn" title="Edit Item">‚úèÔ∏è</button>
                        <button class="btn icon-btn btn-danger delete-item-btn" title="Delete Item">üóëÔ∏è</button>
                    </div>
                `;
                itemListEl.appendChild(itemCard);
            });
        }
        
        function updateHeaderAnalytics() {
            const currentList = appData.lists[appData.currentListId];
            if (!currentList) {
                totalItemsEl.textContent = '0';
                totalSpentEl.textContent = '$0.00';
                avgPriceEl.textContent = '$0.00';
                return;
            }
            const items = currentList.items;
            const totalIndividualItems = items.reduce((sum, item) => sum + item.quantity, 0);
            const totalSpent = items.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
            const avgPrice = totalIndividualItems > 0 ? totalSpent / totalIndividualItems : 0;
            totalItemsEl.textContent = totalIndividualItems;
            totalSpentEl.textContent = `$${totalSpent.toFixed(2)}`;
            avgPriceEl.textContent = `$${avgPrice.toFixed(2)}`;
        }

        // --- Event Listener & Initializer Setup ---
        function setupEventListeners() {
            listSelector.addEventListener('change', () => {
                appData.currentListId = listSelector.value;
                saveData();
                renderUI();
            });
            addItemForm.addEventListener('submit', handleAddItem);
            
            // Close any modal when its close button is clicked
            document.querySelectorAll('.modal .close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => e.target.closest('.modal').style.display = 'none');
            });
            // Close any modal when clicked outside its content
            window.addEventListener('click', (e) => {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });


            // Header Buttons
            newListBtn.addEventListener('click', () => { document.getElementById('new-list-modal').style.display = 'flex'; });
            createListBtn.addEventListener('click', handleCreateList);
            deleteListBtn.addEventListener('click', handleDeleteList);
            
            // Item actions (delegated from item list)
            itemListEl.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-item-btn');
                const editBtn = e.target.closest('.edit-item-btn');
                if (deleteBtn) handleDeleteItem(e.target.closest('.item-card').dataset.id);
                if (editBtn) openEditItemModal(e.target.closest('.item-card').dataset.id);
            });
            
            // Edit Item Modal actions
            saveItemChangesBtn.addEventListener('click', handleSaveChanges);
            editItemPhotoInput.addEventListener('change', handlePhotoPreview); // For photo in edit modal
            document.getElementById('item-photo').addEventListener('change', handlePhotoPreview); // For photo in add form

            // [V3 Stage 3] Barcode scanner listeners
            scanBarcodeBtn.addEventListener('click', startScanner);
            closeScannerBtn.addEventListener('click', stopScanner);
        }
        
        // [V3 Stage 2] Initialize SortableJS
        function initializeSortable() {
            if (sortableInstance) {
                sortableInstance.destroy(); // Destroy previous instance to re-initialize
            }
            sortableInstance = new Sortable(itemListEl, {
                handle: '.drag-handle', // Drag handle element
                animation: 150,
                ghostClass: 'sortable-ghost', // Class for the ghost element
                chosenClass: 'sortable-chosen', // Class for the chosen item
                onEnd: handleItemDragEnd, // Callback for when drag ends
            });
        }

        // --- Event Handlers ---
        function handleAddItem(e) {
            e.preventDefault();
            const form = e.target;
            const itemName = form.querySelector('#item-name').value.trim();
            const itemPrice = parseFloat(form.querySelector('#item-price').value);
            const itemQuantity = parseInt(form.querySelector('#item-quantity').value, 10);
            
            if (!itemName || isNaN(itemPrice) || isNaN(itemQuantity) || !appData.currentListId) {
                alert("Please fill out all fields correctly.");
                return;
            }
            
            const newItem = {
                id: generateId(),
                name: itemName,
                price: itemPrice,
                quantity: itemQuantity,
                photo: photoPreview.src, // Uses the URL from the preview
                createdAt: new Date().toISOString()
            };
            
            appData.lists[appData.currentListId].items.push(newItem);
            saveData();
            renderUI(); // Re-render to show new item and update analytics
            form.reset(); // Clear form inputs
            photoPreview.style.display = 'none'; // Hide photo preview
            photoPreview.src = ''; // Clear photo preview source
        }
        
        function handleCreateList() {
            const listNameInput = document.getElementById('new-list-name');
            const listName = listNameInput.value.trim();
            if (!listName) return;
            
            // Check for duplicate list names
            if (Object.values(appData.lists).some(list => list.name === listName)) {
                alert('A list with this name already exists. Please choose a different name.');
                return;
            }

            const listId = generateId();
            appData.lists[listId] = {
                id: listId, 
                name: listName, 
                items: [], 
                createdAt: new Date().toISOString(), 
                groupId: null, 
                budget: null
            };
            appData.currentListId = listId; // Set newly created list as current
            saveData();
            renderUI(); // Re-render to show new list
            newListModal.style.display = 'none'; // Close modal
            listNameInput.value = ''; // Clear input
        }
        
        function handleDeleteList() {
            if (!appData.currentListId) return;
            const listName = appData.lists[appData.currentListId].name;
            if (confirm(`Are you sure you want to delete the list "${listName}"? This action cannot be undone.`)) {
                delete appData.lists[appData.currentListId];
                // Try to set currentListId to the first remaining list, or null if none
                appData.currentListId = Object.keys(appData.lists)[0] || null;
                saveData();
                renderUI(); // Re-render the UI
            }
        }

        function handleDeleteItem(itemId) {
            const list = appData.lists[appData.currentListId];
            if (!list) return; // Should not happen if item exists
            
            list.items = list.items.filter(item => item.id !== itemId);
            saveData();
            renderUI(); // Re-render to remove item and update analytics
        }

        // [V3] Edit Item Functions
        function openEditItemModal(itemId) {
            const list = appData.lists[appData.currentListId];
            const item = list.items.find(i => i.id === itemId);
            if (!item) {
                console.error("Item not found for editing:", itemId);
                return; // Should not happen
            }

            // Populate the edit form fields
            editItemIdInput.value = item.id;
            editItemNameInput.value = item.name;
            editItemPriceInput.value = item.price;
            editItemQuantityInput.value = item.quantity;
            editPhotoPreview.src = item.photo || '';
            editPhotoPreview.style.display = item.photo ? 'block' : 'none';
            editItemPhotoInput.value = ''; // Clear file input value for new selection
            
            editItemModal.style.display = 'flex'; // Show the modal
        }
        
        function handleSaveChanges() {
            const itemId = editItemIdInput.value;
            const list = appData.lists[appData.currentListId];
            const itemIndex = list.items.findIndex(i => i.id === itemId);
            if (itemIndex === -1) {
                alert("Error: Item not found to save changes.");
                return;
            }
            
            const updatedName = editItemNameInput.value.trim();
            const updatedPrice = parseFloat(editItemPriceInput.value);
            const updatedQuantity = parseInt(editItemQuantityInput.value, 10);
            
            if (!updatedName || isNaN(updatedPrice) || isNaN(updatedQuantity)) {
                alert("Please fill out all fields correctly.");
                return;
            }
            
            // Update item properties
            list.items[itemIndex].name = updatedName;
            list.items[itemIndex].price = updatedPrice;
            list.items[itemIndex].quantity = updatedQuantity;
            
            // Check if photo was changed (by comparing current preview src with original)
            // Note: If photo input was empty, preview.src might be '' or placeholder,
            // but if a new file was selected, preview.src will have been updated by handlePhotoPreview
            list.items[itemIndex].photo = editPhotoPreview.src;

            saveData();
            renderUI(); // Re-render to show updated item
            editItemModal.style.display = 'none'; // Close modal
        }
        
        // [V3 Stage 2] Handle the end of a drag event
        function handleItemDragEnd(evt) {
            const { oldIndex, newIndex } = evt;
            const list = appData.lists[appData.currentListId];
            if (!list) return;

            // Reorder the array in our appData to match the new DOM order
            const [movedItem] = list.items.splice(oldIndex, 1); // Remove item from old position
            list.items.splice(newIndex, 0, movedItem);         // Insert item into new position

            saveData(); // Save the new order
            // No full renderUI() needed here because SortableJS directly updates the DOM
        }

        // Generic Photo Preview Handler for both add and edit forms
        function handlePhotoPreview(event) {
            const input = event.target;
            // Determine which preview image to update based on the input's ID
            const previewEl = input.id === 'edit-item-photo' ? editPhotoPreview : photoPreview;
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewEl.src = e.target.result;
                    previewEl.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewEl.src = '';
                previewEl.style.display = 'none';
            }
        }
        
        // [V3 Stage 3] Barcode Scanner Functions
        function startScanner() {
            // Hide the add item form and show the scanner container
            addItemForm.style.display = 'none';
            scannerContainer.style.display = 'block';

            // Html5Qrcode config: set FPS and scan box size
            const config = { fps: 10, qrbox: { width: 250, height: 150 } };
            
            // Callback for successful scan
            const onScanSuccess = (decodedText, decodedResult) => {
                stopScanner(); // Stop scanner immediately on success
                fetchProductInfo(decodedText); // Fetch product data using the barcode
            };
            
            // Callback for scan failures/errors (optional, good for debugging)
            const onScanFailure = (error) => {
                // console.warn(`Scan error: ${error}`); // Log errors to console
            };
            
            // Start the scanner, requesting the 'environment' (back) camera
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => {
                    // Handle errors during scanner startup (e.g., camera permission denied)
                    alert("Could not start scanner. Please ensure camera permissions are granted.");
                    stopScanner(); // Try to stop to clean up even if start failed
                });
        }
        
        function stopScanner() {
            // Stop the html5QrCode scanner and hide its container
            html5QrCode.stop().then(() => {
                scannerContainer.style.display = 'none';
                addItemForm.style.display = 'block'; // Show add item form again
            }).catch(err => {
                 // Fallback if stop fails, ensure UI is restored
                 console.error("Error stopping scanner:", err);
                 scannerContainer.style.display = 'none';
                 addItemForm.style.display = 'block';
            });
        }
        
        async function fetchProductInfo(barcode) {
            // User feedback for API call
            alert(`Searching for product with barcode: ${barcode}...`);
            try {
                // Open Food Facts API endpoint
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Check if product was found (status 1 means found)
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    document.getElementById('item-name').value = product.product_name || product.generic_name || 'Unknown Product';
                    
                    // Prioritize specific image URLs, fallback to generic
                    const imageUrl = product.image_front_url || product.image_url || '';
                    if (imageUrl) {
                        const preview = document.getElementById('photo-preview');
                        preview.src = imageUrl;
                        preview.style.display = 'block';
                    } else {
                        photoPreview.style.display = 'none';
                        photoPreview.src = '';
                    }
                    alert("Product found! Please enter price and quantity.");
                } else {
                    alert("Product not found in the Open Food Facts database.");
                    document.getElementById('item-name').value = ''; // Clear name if not found
                    photoPreview.style.display = 'none';
                    photoPreview.src = '';
                }
            } catch (error) {
                console.error("Error fetching product info:", error);
                alert("Failed to fetch product information. Please check your internet connection or try again manually.");
                document.getElementById('item-name').value = '';
                photoPreview.style.display = 'none';
                photoPreview.src = '';
            }
        }

        // --- Start the App ---
        initialize();
    });
    </script>
</body>
</html>
