<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shopping List V3 - Stage 4</title>
    <!-- V3 Library Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --danger-color: #c0392b;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --background-gradient: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            --white: #ffffff;
            --light-gray: #f0f0f0;
            --dark-gray: #333333;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: var(--background-gradient);
            color: var(--dark-gray);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 15px;
            box-sizing: border-box;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        header {
            background: var(--white);
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .header-row:not(:last-child) { margin-bottom: 10px; }
        #list-selector { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); font-size: 16px; }

        .btn { padding: 10px 15px; border: none; border-radius: var(--border-radius); background: var(--primary-color); color: var(--white); cursor: pointer; font-size: 16px; transition: background 0.3s; flex-shrink: 0; }
        .btn:hover { background: #732d91; }
        .btn-secondary { background: var(--secondary-color); }
        .btn-secondary:hover { background: #2980b9; }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #a5281b; }
        .btn-small { padding: 5px 10px; font-size: 14px; }
        .icon-btn { padding: 8px; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center; }

        .analytics-header { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; background: rgba(255,255,255,0.5); }
        .metric { font-size: 14px; }
        .metric span { display: block; font-weight: bold; font-size: 18px; }

        main { padding: 20px; }
        
        #barcode-scanner-container { display: none; margin-bottom: 15px; }
        #barcode-reader { border: 2px solid #ddd; border-radius: var(--border-radius); }

        .add-item-form { background: var(--white); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--shadow); }
        .form-row { display: flex; gap: 10px; align-items: center; }
        .form-group { margin-bottom: 15px; flex-grow: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); box-sizing: border-box; }
        #photo-preview { max-width: 100px; margin-top: 10px; border-radius: var(--border-radius); display: none; }

        #item-list { display: grid; gap: 15px; }
        .item-card { background: var(--white); padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; position: relative; }
        .item-card .drag-handle { cursor: grab; font-size: 24px; color: #ccc; padding-right: 5px; }
        .item-card .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #e0c8ee; }
        .sortable-chosen { box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

        .item-card img { width: 60px; height: 60px; border-radius: var(--border-radius); object-fit: cover; }
        .item-info { flex-grow: 1; }
        .item-info h3 { margin: 0; font-size: 18px; }
        .item-info p { margin: 5px 0 0; font-size: 16px; color: var(--primary-color); font-weight: bold; }
        .item-actions { display: flex; gap: 5px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--light-gray); padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); position: relative; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: var(--border-radius); box-sizing: border-box; margin-bottom: 15px; }
        .modal-footer { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; display:flex; gap: 10px; }
        
        /* [V3 Stage 4] Group Management Styles */
        .management-list { list-style: none; padding: 0; margin: 0; }
        .management-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 10px; background: var(--white); border-radius: var(--border-radius); margin-bottom: 10px; }
        .management-item .name { font-weight: bold; }
        .management-item select { margin-bottom: 0; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="header-row">
                <select id="list-selector"></select>
                <button class="btn icon-btn" id="new-list-btn" title="New List">+</button>
                <button class="btn btn-danger icon-btn" id="delete-list-btn" title="Delete Selected List">üóëÔ∏è</button>
            </div>
            <div class="header-row">
                <button class="btn btn-secondary btn-small" id="manage-groups-btn">üóÇÔ∏è Groups</button>
                <button class="btn btn-secondary btn-small" id="global-analytics-btn">üìà Analytics</button>
                <button class="btn btn-secondary btn-small" id="settings-btn">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <div class="analytics-header">
            <div class="metric">Total Items <span id="total-items">0</span></div>
            <div class="metric">Total Spent <span id="total-spent">$0.00</span></div>
            <div class="metric">Avg. Price <span id="avg-price">$0.00</span></div>
        </div>

        <main>
            <div id="barcode-scanner-container">
                <div id="barcode-reader"></div>
                <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" id="close-scanner-btn">Close Scanner</button>
            </div>
            <form class="add-item-form" id="add-item-form">
                <div class="form-row">
                    <div class="form-group" style="flex-grow: 4;"><label for="item-name">Item Name</label><input type="text" id="item-name" required></div>
                    <div class="form-group"><label>¬†</label><button type="button" class="btn icon-btn" id="scan-barcode-btn" title="Scan Barcode">üì∑</button></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="item-price">Price</label><input type="number" id="item-price" step="0.01" min="0" required></div>
                    <div class="form-group"><label for="item-quantity">Quantity</label><input type="number" id="item-quantity" value="1" min="1" required></div>
                </div>
                <div class="form-group"><label for="item-photo">Price Tag Photo (Optional)</label><input type="file" id="item-photo" accept="image/*"><img id="photo-preview" src="" alt="Photo Preview"></div>
                <button type="submit" class="btn" style="width: 100%;">Add Item</button>
            </form>
            <h2 id="current-list-title"></h2>
            <div id="item-list"></div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="new-list-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Create New List</h2><span class="close-btn">√ó</span></div><div class="modal-body"><input type="text" id="new-list-name" placeholder="e.g., Weekly Groceries"></div><div class="modal-footer"><button class="btn" id="create-list-btn" style="width:100%;">Create List</button></div></div></div>
    <div id="edit-item-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edit Item</h2><span class="close-btn">√ó</span></div><div class="modal-body"><input type="hidden" id="edit-item-id"><div class="form-group"><label for="edit-item-name">Item Name</label><input type="text" id="edit-item-name" required></div><div class="form-row"><div class="form-group"><label for="edit-item-price">Price</label><input type="number" id="edit-item-price" step="0.01" min="0" required></div><div class="form-group"><label for="edit-item-quantity">Quantity</label><input type="number" id="edit-item-quantity" min="1" required></div></div><div class="form-group"><label for="edit-item-photo">Change Photo</label><input type="file" id="edit-item-photo" accept="image/*"><img id="edit-photo-preview" src="" style="max-width:100px; margin-top:10px; border-radius: var(--border-radius);"></div></div><div class="modal-footer"><button class="btn" id="save-item-changes-btn" style="width:100%;">Save Changes</button></div></div></div>
    
    <!-- [V3 Stage 4] Manage Groups Modal -->
    <div id="manage-groups-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Manage Groups</h2><span class="close-btn">√ó</span></div>
            <div class="modal-body">
                <h3>Create New Group</h3>
                <div class="form-row">
                    <input type="text" id="new-group-name" placeholder="e.g., Vacation Prep">
                    <button class="btn" id="create-group-btn">Create</button>
                </div>
                <hr style="margin: 20px 0;">
                <h3>Assign Lists to Groups</h3>
                <ul id="list-group-assignments" class="management-list">
                    <!-- Assignment items will be dynamically generated here -->
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Placeholder Modals -->
    <div id="global-analytics-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Global Analytics</h2><span class="close-btn">√ó</span></div><div class="modal-body"></div></div></div>
    <div id="settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Settings & Data</h2><span class="close-btn">√ó</span></div><div class="modal-body"></div></div></div>
    <div id="analytics-filter-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Filter Analytics Data</h2><span class="close-btn">√ó</span></div><div class="modal-body"></div></div></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State ---
        let appData = { lists: {}, groups: {}, currentListId: null };
        let sortableInstance = null;
        let html5QrCode = null;

        // --- DOM Elements ---
        const listSelector = document.getElementById('list-selector');
        const currentListTitle = document.getElementById('current-list-title');
        const itemListEl = document.getElementById('item-list');
        const addItemForm = document.getElementById('add-item-form');
        const totalItemsEl = document.getElementById('total-items');
        const totalSpentEl = document.getElementById('total-spent');
        const avgPriceEl = document.getElementById('avg-price');
        const newListModal = document.getElementById('new-list-modal');
        const newListBtn = document.getElementById('new-list-btn');
        const createListBtn = document.getElementById('create-list-btn');
        const deleteListBtn = document.getElementById('delete-list-btn');
        const editItemModal = document.getElementById('edit-item-modal');
        const saveItemChangesBtn = document.getElementById('save-item-changes-btn');
        const editItemIdInput = document.getElementById('edit-item-id');
        const editItemNameInput = document.getElementById('edit-item-name');
        const editItemPriceInput = document.getElementById('edit-item-price');
        const editItemQuantityInput = document.getElementById('edit-item-quantity');
        const editItemPhotoInput = document.getElementById('edit-item-photo');
        const editPhotoPreview = document.getElementById('edit-photo-preview');
        const manageGroupsBtn = document.getElementById('manage-groups-btn');
        const scannerContainer = document.getElementById('barcode-scanner-container');
        const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
        const closeScannerBtn = document.getElementById('close-scanner-btn');
        const photoPreview = document.getElementById('photo-preview');
        // [V3 Stage 4] Group Management Modal Elements
        const manageGroupsModal = document.getElementById('manage-groups-modal');
        const createGroupBtn = document.getElementById('create-group-btn');
        const newGroupNameInput = document.getElementById('new-group-name');
        const listGroupAssignmentsEl = document.getElementById('list-group-assignments');

        // --- Data Functions ---
        const loadData = () => { if (localStorage.getItem('shoppingAppV3')) appData = JSON.parse(localStorage.getItem('shoppingAppV3')); };
        const saveData = () => localStorage.setItem('shoppingAppV3', JSON.stringify(appData));
        const generateId = () => Date.now().toString() + Math.random().toString(36).substr(2, 9);

        // --- Initialization ---
        function initialize() {
            loadData();
            if (Object.keys(appData.lists).length === 0) {
                const firstListId = generateId();
                appData.lists[firstListId] = { id: firstListId, name: "My First List", items: [], createdAt: new Date().toISOString(), groupId: null, budget: null };
                appData.currentListId = firstListId;
                if (!appData.groups) appData.groups = {}; // Ensure groups object exists
                saveData();
            }
            appData.currentListId = appData.currentListId || Object.keys(appData.lists)[0] || null;
            if (!appData.groups) appData.groups = {};
            html5QrCode = new Html5Qrcode("barcode-reader");
            setupEventListeners();
            initializeSortable();
            renderUI();
        }

        // --- UI Rendering ---
        function renderUI() {
            const currentList = appData.lists[appData.currentListId];
            currentListTitle.textContent = currentList ? currentList.name : "No list selected";
            if (!currentList) itemListEl.innerHTML = '';
            renderListSelector();
            renderItems();
            updateHeaderAnalytics();
        }

        function renderListSelector() {
            listSelector.innerHTML = '';
            
            // Get all groups and sort them alphabetically
            const sortedGroups = Object.values(appData.groups).sort((a, b) => a.name.localeCompare(b.name));
            
            // Create a map for quick lookup
            const groupedLists = {};
            sortedGroups.forEach(group => groupedLists[group.id] = []);
            const ungroupedLists = [];

            Object.values(appData.lists).forEach(list => {
                if (list.groupId && appData.groups[list.groupId]) {
                    groupedLists[list.groupId].push(list);
                } else {
                    ungroupedLists.push(list);
                }
            });

            // Render grouped lists
            sortedGroups.forEach(group => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.name;
                groupedLists[group.id].sort((a,b) => a.name.localeCompare(b.name)).forEach(list => {
                    optgroup.appendChild(createOption(list));
                });
                listSelector.appendChild(optgroup);
            });

            // Render ungrouped lists
            if (ungroupedLists.length > 0) {
                const ungroupedOptgroup = document.createElement('optgroup');
                ungroupedOptgroup.label = "Ungrouped";
                ungroupedLists.sort((a,b) => a.name.localeCompare(b.name)).forEach(list => {
                    ungroupedOptgroup.appendChild(createOption(list));
                });
                listSelector.appendChild(ungroupedOptgroup);
            }

            function createOption(list) {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = list.name;
                if (list.id === appData.currentListId) option.selected = true;
                return option;
            }

            deleteListBtn.style.display = Object.keys(appData.lists).length > 0 ? 'flex' : 'none';
        }
        
        function renderItems() {
            itemListEl.innerHTML = '';
            const currentList = appData.lists[appData.currentListId];
            if (!currentList) return;
            currentList.items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card'; itemCard.dataset.id = item.id;
                const quantityText = item.quantity > 1 ? ` (x${item.quantity})` : '';
                itemCard.innerHTML = `<span class="drag-handle" title="Drag to reorder">‚†ø</span><img src="${item.photo || 'https://via.placeholder.com/60'}" alt="${item.name}"><div class="item-info"><h3>${item.name}${quantityText}</h3><p>$${(parseFloat(item.price) * item.quantity).toFixed(2)}</p></div><div class="item-actions"><button class="btn icon-btn btn-secondary edit-item-btn" title="Edit Item">‚úèÔ∏è</button><button class="btn icon-btn btn-danger delete-item-btn" title="Delete Item">üóëÔ∏è</button></div>`;
                itemListEl.appendChild(itemCard);
            });
        }
        
        function updateHeaderAnalytics() {
            const currentList = appData.lists[appData.currentListId];
            if (!currentList) { totalItemsEl.textContent = '0'; totalSpentEl.textContent = '$0.00'; avgPriceEl.textContent = '$0.00'; return; }
            const items = currentList.items;
            const totalIndividualItems = items.reduce((sum, item) => sum + item.quantity, 0);
            const totalSpent = items.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
            const avgPrice = totalIndividualItems > 0 ? totalSpent / totalIndividualItems : 0;
            totalItemsEl.textContent = totalIndividualItems; totalSpentEl.textContent = `$${totalSpent.toFixed(2)}`; avgPriceEl.textContent = `$${avgPrice.toFixed(2)}`;
        }

        // --- Event Listener Setup ---
        function setupEventListeners() {
            listSelector.addEventListener('change', () => { appData.currentListId = listSelector.value; saveData(); renderUI(); });
            addItemForm.addEventListener('submit', handleAddItem);
            document.querySelectorAll('.modal .close-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal').style.display = 'none'));
            window.addEventListener('click', (e) => { document.querySelectorAll('.modal').forEach(modal => { if (e.target === modal) modal.style.display = 'none'; }); });
            newListBtn.addEventListener('click', () => { newListModal.style.display = 'flex'; });
            createListBtn.addEventListener('click', handleCreateList);
            deleteListBtn.addEventListener('click', handleDeleteList);
            itemListEl.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-item-btn');
                const editBtn = e.target.closest('.edit-item-btn');
                if (deleteBtn) handleDeleteItem(e.target.closest('.item-card').dataset.id);
                if (editBtn) openEditItemModal(e.target.closest('.item-card').dataset.id);
            });
            saveItemChangesBtn.addEventListener('click', handleSaveChanges);
            editItemPhotoInput.addEventListener('change', handlePhotoPreview);
            document.getElementById('item-photo').addEventListener('change', handlePhotoPreview);
            scanBarcodeBtn.addEventListener('click', startScanner);
            closeScannerBtn.addEventListener('click', stopScanner);
            // [V3 Stage 4] Group Management Listeners
            manageGroupsBtn.addEventListener('click', openGroupManager);
            createGroupBtn.addEventListener('click', handleCreateGroup);
            listGroupAssignmentsEl.addEventListener('change', handleAssignListToGroup);
        }
        
        function initializeSortable() {
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(itemListEl, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', onEnd: handleItemDragEnd });
        }

        // --- Event Handlers (omitting unchanged ones for brevity) ---
        function handleAddItem(e) { /* Full implementation here */ e.preventDefault(); const form=e.target,itemName=form.querySelector("#item-name").value.trim(),itemPrice=parseFloat(form.querySelector("#item-price").value),itemQuantity=parseInt(form.querySelector("#item-quantity").value,10); if(!itemName||isNaN(itemPrice)||isNaN(itemQuantity)||!appData.currentListId)return void alert("Please fill out all fields correctly."); const newItem={id:generateId(),name:itemName,price:itemPrice,quantity:itemQuantity,photo:photoPreview.src,createdAt:(new Date).toISOString()}; appData.lists[appData.currentListId].items.push(newItem),saveData(),renderUI(),form.reset(),photoPreview.style.display="none",photoPreview.src="" }
        function handleCreateList() { /* Full implementation here */ const e=document.getElementById("new-list-name"),t=e.value.trim();if(t){if(Object.values(appData.lists).some(e=>e.name===t))return void alert("A list with this name already exists. Please choose a different name.");const o=generateId();appData.lists[o]={id:o,name:t,items:[],createdAt:(new Date).toISOString(),groupId:null,budget:null},appData.currentListId=o,saveData(),renderUI(),newListModal.style.display="none",e.value=""} }
        function handleDeleteList() { /* Full implementation here */ if(appData.currentListId){const e=appData.lists[appData.currentListId].name;confirm(`Are you sure you want to delete the list "${e}"? This action cannot be undone.`)&&(delete appData.lists[appData.currentListId],appData.currentListId=Object.keys(appData.lists)[0]||null,saveData(),renderUI())} }
        function handleDeleteItem(e) { /* Full implementation here */ const t=appData.lists[appData.currentListId];t&&(t.items=t.items.filter(t=>t.id!==e),saveData(),renderUI()) }
        function openEditItemModal(e) { /* Full implementation here */ const t=appData.lists[appData.currentListId],o=t.items.find(t=>t.id===e);o&&(editItemIdInput.value=o.id,editItemNameInput.value=o.name,editItemPriceInput.value=o.price,editItemQuantityInput.value=o.quantity,editPhotoPreview.src=o.photo||"",editPhotoPreview.style.display=o.photo?"block":"none",editItemPhotoInput.value="",editItemModal.style.display="flex") }
        function handleSaveChanges() { /* Full implementation here */ const e=editItemIdInput.value,t=appData.lists[appData.currentListId],o=t.items.findIndex(t=>t.id===e);if(-1!==o){const i=editItemNameInput.value.trim(),n=parseFloat(editItemPriceInput.value),d=parseInt(editItemQuantityInput.value,10);if(!i||isNaN(n)||isNaN(d))return void alert("Please fill out all fields correctly.");t.items[o].name=i,t.items[o].price=n,t.items[o].quantity=d,t.items[o].photo=editPhotoPreview.src,saveData(),renderUI(),editItemModal.style.display="none"}else alert("Error: Item not found to save changes.") }
        function handleItemDragEnd(e) { /* Full implementation here */ const{oldIndex:t,newIndex:o}=e,i=appData.lists[appData.currentListId];if(i){const[n]=i.items.splice(t,1);i.items.splice(o,0,n),saveData()} }
        function handlePhotoPreview(e) { /* Full implementation here */ const t=e.target,o="edit-item-photo"===t.id?editPhotoPreview:photoPreview,i=t.files[0];i?((new FileReader).onload=e=>{o.src=e.target.result,o.style.display="block"},reader.readAsDataURL(i)):(o.src="",o.style.display="none")}
        function startScanner() { /* Full implementation here */ addItemForm.style.display="none",scannerContainer.style.display="block";const e={fps:10,qrbox:{width:250,height:150}},t=(e,t)=>{stopScanner(),fetchProductInfo(e)};html5QrCode.start({facingMode:"environment"},e,t,e=>{})}
        function stopScanner() { /* Full implementation here */ html5QrCode.stop().then(e=>{scannerContainer.style.display="none",addItemForm.style.display="block"}).catch(e=>{console.error("Error stopping scanner:",e),scannerContainer.style.display="none",addItemForm.style.display="block"})}
        async function fetchProductInfo(e) { /* Full implementation here */ alert(`Searching for product with barcode: ${e}...`);try{const t=await fetch(`https://world.openfoodfacts.org/api/v0/product/${e}.json`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=await t.json();if(1===o.status&&o.product){const e=o.product;document.getElementById("item-name").value=e.product_name||e.generic_name||"Unknown Product";const t=e.image_front_url||e.image_url||"";t?(photoPreview.src=t,photoPreview.style.display="block"):(photoPreview.style.display="none",photoPreview.src=""),alert("Product found! Please enter price and quantity.")}else alert("Product not found in the Open Food Facts database."),document.getElementById("item-name").value="",photoPreview.style.display="none",photoPreview.src=""}catch(e){console.error("Error fetching product info:",e),alert("Failed to fetch product information. Please check your internet connection or try again manually."),document.getElementById("item-name").value="",photoPreview.style.display="none",photoPreview.src=""}}

        // [V3 Stage 4] Group Management Functions
        function openGroupManager() {
            renderGroupManager();
            manageGroupsModal.style.display = 'flex';
        }

        function renderGroupManager() {
            listGroupAssignmentsEl.innerHTML = '';
            Object.values(appData.lists).sort((a,b)=>a.name.localeCompare(b.name)).forEach(list => {
                const li = document.createElement('li');
                li.className = 'management-item';
                
                const select = document.createElement('select');
                select.dataset.listId = list.id;
                
                // Add default "Ungrouped" option
                const defaultOption = document.createElement('option');
                defaultOption.value = 'null';
                defaultOption.textContent = 'Ungrouped';
                select.appendChild(defaultOption);

                // Add an option for each group
                Object.values(appData.groups).sort((a,b)=>a.name.localeCompare(b.name)).forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    if (list.groupId === group.id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                li.innerHTML = `<span class="name">${list.name}</span>`;
                li.appendChild(select);
                listGroupAssignmentsEl.appendChild(li);
            });
        }

        function handleCreateGroup() {
            const groupName = newGroupNameInput.value.trim();
            if (!groupName) {
                alert("Group name cannot be empty.");
                return;
            }
            if (Object.values(appData.groups).some(g => g.name === groupName)) {
                alert("A group with this name already exists.");
                return;
            }
            const groupId = generateId();
            appData.groups[groupId] = { id: groupId, name: groupName };
            saveData();
            renderGroupManager(); // Re-render the manager to include the new group
            newGroupNameInput.value = '';
        }

        function handleAssignListToGroup(event) {
            const selectEl = event.target;
            const listId = selectEl.dataset.listId;
            const groupId = selectEl.value === 'null' ? null : selectEl.value;

            if (appData.lists[listId]) {
                appData.lists[listId].groupId = groupId;
                saveData();
                renderListSelector(); // Re-render the main selector to reflect the change
            }
        }

        // --- Start the App ---
        initialize();
    });
    </script>
</body>
</html>
